<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>McFarlin Operations</title>
<style>
  :root {--bg:#0f1117;--card:#1a1d27;--border:#2a2d3a;--text:#e4e4e7;--muted:#71717a;--green:#22c55e;--gbg:rgba(34,197,94,.12);--red:#ef4444;--rbg:rgba(239,68,68,.12);--yellow:#eab308;--ybg:rgba(234,179,8,.12);--blue:#3b82f6;--bbg:rgba(59,130,246,.12);--purple:#a855f7;--pbg:rgba(168,85,247,.12)}
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:-apple-system,BlinkMacSystemFont,'SF Pro Text',system-ui,sans-serif;background:var(--bg);color:var(--text);line-height:1.5;padding:16px;max-width:1200px;margin:0 auto}
  a{color:var(--blue);text-decoration:none}

  /* Heartbeat banner */
  .hb{padding:12px 16px;border-radius:10px;margin-bottom:16px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px}
  .hb-online{background:var(--gbg);border:1px solid rgba(34,197,94,.3)}
  .hb-delayed{background:var(--ybg);border:1px solid rgba(234,179,8,.3)}
  .hb-offline{background:var(--rbg);border:1px solid rgba(239,68,68,.3);animation:pulse 2s infinite}
  .hb-unknown{background:var(--card);border:1px solid var(--border)}
  @keyframes pulse{0%,100%{opacity:1}50%{opacity:.7}}
  .hb-status{font-weight:700;font-size:.9rem;display:flex;align-items:center;gap:8px}
  .hb-detail{font-size:.75rem;color:var(--muted)}
  .hb-dot{width:10px;height:10px;border-radius:50%;display:inline-block}

  h1{font-size:1.5rem;font-weight:700;margin-bottom:4px}
  .sub{color:var(--muted);font-size:.85rem;margin-bottom:16px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:12px}
  .card-t{font-size:.75rem;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--muted);margin-bottom:12px}
  .grid{display:grid;gap:12px}.g2{grid-template-columns:1fr 1fr}.g3{grid-template-columns:1fr 1fr 1fr}.g4{grid-template-columns:1fr 1fr 1fr 1fr}
  @media(max-width:768px){.g2,.g3,.g4{grid-template-columns:1fr}body{padding:12px}}

  /* Tabs */
  .tabs{display:flex;gap:4px;margin-bottom:16px;border-bottom:1px solid var(--border);padding-bottom:0;overflow-x:auto}
  .tab{padding:10px 20px;font-size:.85rem;font-weight:600;color:var(--muted);cursor:pointer;border-bottom:2px solid transparent;transition:all .2s;white-space:nowrap}
  .tab:hover{color:var(--text)}
  .tab.active{color:var(--blue);border-bottom-color:var(--blue)}
  .tab-content{display:none}.tab-content.active{display:block}

  /* Badges */
  .badge{display:inline-flex;align-items:center;gap:5px;padding:3px 10px;border-radius:20px;font-size:.72rem;font-weight:600}
  .bg{background:var(--gbg);color:var(--green)}.br{background:var(--rbg);color:var(--red)}.by{background:var(--ybg);color:var(--yellow)}.bb{background:var(--bbg);color:var(--blue)}.bp{background:var(--pbg);color:var(--purple)}
  .dot{width:6px;height:6px;border-radius:50%;display:inline-block}
  .dg{background:var(--green)}.dr{background:var(--red)}.dy{background:var(--yellow)}.db{background:var(--blue)}

  /* Mini stats */
  .hdr{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:16px;flex-wrap:wrap;gap:12px}
  .stats{display:flex;gap:10px;flex-wrap:wrap}
  .ms{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:8px 14px;text-align:center;min-width:80px}
  .ms .v{font-size:1.3rem;font-weight:700}.ms .l{font-size:.75rem;color:var(--muted)}

  /* Agent rows */
  .ar{border-bottom:1px solid var(--border);cursor:pointer;transition:background .15s}
  .ar:last-child{border-bottom:none}
  .ar:hover{background:rgba(59,130,246,.05)}
  .ar-main{display:flex;align-items:center;justify-content:space-between;padding:10px 0;gap:8px}
  .ar-left{display:flex;align-items:center;flex:1;min-width:0}
  .anum{width:28px;height:28px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:.75rem;font-weight:700;margin-right:12px;flex-shrink:0}
  .aname{font-size:.9rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .adet{font-size:.75rem;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

  /* Escalations */
  .esc{padding:12px;background:var(--rbg);border:1px solid rgba(239,68,68,.25);border-radius:8px;margin-bottom:8px}
  .esc:last-child{margin-bottom:0}
  .esc-t{font-size:.85rem;font-weight:600;color:var(--red)}.esc-d{font-size:.75rem;color:var(--muted);margin-top:4px}

  /* Deadlines */
  .dl{padding:6px 0;border-bottom:1px solid var(--border);font-size:.85rem;display:flex;justify-content:space-between;align-items:center;gap:8px}
  .dl:last-child{border-bottom:none}

  /* Progress bar */
  .pb{width:100%;height:6px;background:var(--border);border-radius:3px;margin-top:8px;overflow:hidden}
  .pf{height:100%;border-radius:3px}

  /* Health items */
  .hi{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--border);font-size:.85rem}
  .hi:last-child{border-bottom:none}

  /* Loading / error */
  .loading{text-align:center;padding:40px;color:var(--muted);font-size:.9rem}
  .loading-spin{display:inline-block;width:20px;height:20px;border:2px solid var(--border);border-top-color:var(--blue);border-radius:50%;animation:spin .8s linear infinite;margin-bottom:12px}
  @keyframes spin{to{transform:rotate(360deg)}}

  .section{margin-bottom:16px}
  .sec-t{font-size:1.1rem;font-weight:700;margin-bottom:12px;display:flex;align-items:center;gap:8px}
  .ts{text-align:center;color:var(--muted);font-size:.7rem;margin-top:20px;padding-top:16px;border-top:1px solid var(--border)}
  .refresh-btn{background:var(--card);border:1px solid var(--border);color:var(--muted);padding:4px 12px;border-radius:6px;font-size:.75rem;cursor:pointer;transition:all .2s}
  .refresh-btn:hover{color:var(--text);border-color:var(--blue)}

  /* Role switcher */
  .role-switcher{display:flex;align-items:center;gap:8px;margin-bottom:16px;padding:10px 14px;background:var(--card);border:1px solid var(--border);border-radius:10px}
  .role-switcher label{font-size:.75rem;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.05em}
  .role-switcher select{background:var(--bg);color:var(--text);border:1px solid var(--border);border-radius:6px;padding:6px 10px;font-size:.85rem;cursor:pointer}
  .role-switcher select:focus{outline:none;border-color:var(--blue)}
  .role-tag{font-size:.7rem;padding:2px 8px;border-radius:12px;background:var(--pbg);color:var(--purple);font-weight:600}

  /* Approval items */
  .approval-item{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:16px;margin-bottom:12px}
  .approval-item .ai-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .approval-item .ai-title{font-size:.9rem;font-weight:600}
  .approval-item .ai-agent{font-size:.72rem;color:var(--muted)}
  .approval-item .ai-desc{font-size:.85rem;color:var(--muted);margin-bottom:12px;line-height:1.4}
  .approval-item .ai-actions{display:flex;gap:8px}
  .btn{padding:8px 16px;border-radius:8px;font-size:.8rem;font-weight:600;cursor:pointer;border:none;transition:all .2s}
  .btn-approve{background:var(--gbg);color:var(--green);border:1px solid rgba(34,197,94,.3)}
  .btn-approve:hover{background:rgba(34,197,94,.25)}
  .btn-reject{background:var(--rbg);color:var(--red);border:1px solid rgba(239,68,68,.3)}
  .btn-reject:hover{background:rgba(239,68,68,.25)}
  .btn-view{background:var(--bbg);color:var(--blue);border:1px solid rgba(59,130,246,.3)}
  .btn-view:hover{background:rgba(59,130,246,.25)}

  /* Empty state */
  .empty-state{text-align:center;padding:40px 20px;color:var(--muted)}
  .empty-state .emoji{font-size:2rem;margin-bottom:8px}
  .empty-state .msg{font-size:.9rem}
  .empty-state .detail{font-size:.75rem;margin-top:4px}

  /* VA task items */
  .task-item{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border);font-size:.85rem}
  .task-item:last-child{border-bottom:none}
  .task-priority{width:8px;height:8px;border-radius:50%;margin-right:10px;flex-shrink:0}

  /* Company cards (Goals tab) */
  .company-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:20px;cursor:pointer;transition:all .2s;position:relative;overflow:hidden}
  .company-card:hover{border-color:var(--blue);transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.3)}
  .company-card-accent{position:absolute;top:0;left:0;right:0;height:3px;border-radius:12px 12px 0 0}
  .company-card-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px}
  .company-card-icon{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.2rem;flex-shrink:0}
  .company-card-info{flex:1;min-width:0;margin-left:12px}
  .company-card-name{font-size:1rem;font-weight:700;margin-bottom:2px}
  .company-card-target{font-size:.75rem;color:var(--muted)}
  .company-card-summary{font-size:.8rem;color:var(--muted);margin-bottom:12px;line-height:1.4}
  .company-card-stats{display:flex;gap:16px;margin-bottom:12px}
  .company-card-stat{text-align:center}
  .company-card-stat .v{font-size:1.1rem;font-weight:700}
  .company-card-stat .l{font-size:.65rem;color:var(--muted);text-transform:uppercase;letter-spacing:.03em}
  .company-card-progress{margin-top:4px}
  .company-card-progress .pb{height:8px;margin-top:0}
  .company-card-progress-label{display:flex;justify-content:space-between;font-size:.7rem;color:var(--muted);margin-top:6px}

  /* Goal detail view */
  .goal-detail{display:none}
  .goal-detail.active{display:block}
  .goal-back{display:inline-flex;align-items:center;gap:6px;font-size:.85rem;color:var(--blue);cursor:pointer;margin-bottom:16px;padding:6px 12px;border-radius:8px;transition:background .15s}
  .goal-back:hover{background:var(--bbg)}
  .goal-company-header{display:flex;align-items:center;gap:12px;margin-bottom:20px;padding-bottom:16px;border-bottom:1px solid var(--border)}
  .goal-company-title{font-size:1.3rem;font-weight:700}
  .goal-company-meta{font-size:.8rem;color:var(--muted)}
  .goal-item{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:16px;margin-bottom:10px}
  .goal-item-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px;gap:8px}
  .goal-item-name{font-size:.9rem;font-weight:600}
  .goal-item-desc{font-size:.8rem;color:var(--muted);margin-bottom:10px}
  .goal-item-date{font-size:.72rem;color:var(--muted)}
  .goal-item .pb{height:8px;margin-top:0;margin-bottom:8px}
  .goal-milestones{display:flex;flex-direction:column;gap:4px}
  .goal-milestone{display:flex;align-items:center;gap:8px;font-size:.8rem;padding:3px 0}
  .goal-milestone-check{width:16px;height:16px;border-radius:4px;border:2px solid var(--border);display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:.65rem}
  .goal-milestone-check.done{background:var(--gbg);border-color:var(--green);color:var(--green)}
  .goal-milestone-label{color:var(--muted)}
  .goal-milestone-label.done{color:var(--text);text-decoration:line-through;opacity:.6}

  /* Annual target bar */
  .annual-target{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:20px;margin-bottom:16px}
  .annual-target-header{display:flex;justify-content:space-between;align-items:baseline;margin-bottom:12px}
  .annual-target-title{font-size:1rem;font-weight:700}
  .annual-target-amount{font-size:1.4rem;font-weight:700}
  .annual-target .pb{height:10px;margin:0}
  .annual-target-labels{display:flex;justify-content:space-between;margin-top:8px;font-size:.75rem;color:var(--muted)}
</style>
</head>
<body>

<!-- ROLE SWITCHER (admin only) -->
<div class="role-switcher" id="role-switcher" style="display:none">
  <label>Viewing as</label>
  <select id="role-select" onchange="switchRole(this.value)"></select>
  <span class="role-tag" id="role-tag"></span>
</div>

<!-- HEARTBEAT BANNER -->
<div class="hb hb-unknown" id="heartbeat">
  <div class="hb-status">
    <span class="hb-dot" id="hb-dot" style="background:var(--muted)"></span>
    <span id="hb-label">Connecting...</span>
  </div>
  <div class="hb-detail" id="hb-detail">Loading dashboard data</div>
</div>

<!-- HEADER -->
<div class="hdr">
  <div>
    <h1 id="dashboard-title">McFarlin Operations</h1>
    <div class="sub" id="date-line">Loading...</div>
  </div>
  <div class="stats" id="summary-stats">
    <div class="ms"><div class="v" style="color:var(--muted)">-</div><div class="l">Active</div></div>
    <div class="ms"><div class="v" style="color:var(--muted)">-</div><div class="l">Blocked</div></div>
    <div class="ms"><div class="v" style="color:var(--muted)">-</div><div class="l">Disabled</div></div>
    <div class="ms"><div class="v" style="color:var(--muted)">-</div><div class="l">Escalations</div></div>
  </div>
</div>

<!-- TABS -->
<div class="tabs" id="tabs-container">
  <div class="tab active" data-tab="overview" onclick="showTab('overview')">Overview</div>
  <div class="tab" data-tab="goals" onclick="showTab('goals')">Goals</div>
  <div class="tab" data-tab="agents" onclick="showTab('agents')">Agents</div>
  <div class="tab" data-tab="approvals" onclick="showTab('approvals')">Approvals</div>
  <div class="tab" data-tab="tasks" onclick="showTab('tasks')">Tasks</div>
  <div class="tab" data-tab="system" onclick="showTab('system')">System</div>
</div>

<!-- OVERVIEW TAB -->
<div class="tab-content active" id="tab-overview">
  <div id="escalations-section" class="section" style="display:none">
    <div class="sec-t"><span style="color:var(--red)">&#9888;</span> Needs Your Attention</div>
    <div id="escalations-list"></div>
  </div>

  <div class="grid g2 section">
    <div class="card">
      <div class="card-t">Key Deadlines</div>
      <div id="deadlines-list">
        <div class="loading"><div class="loading-spin"></div><br>Loading...</div>
      </div>
    </div>
    <div class="card">
      <div class="card-t">Task Queue</div>
      <div id="tasks-summary">
        <div class="loading"><div class="loading-spin"></div><br>Loading...</div>
      </div>
    </div>
  </div>
</div>

<!-- GOALS TAB -->
<div class="tab-content" id="tab-goals">
  <!-- Company overview (default view) -->
  <div id="goals-overview">
    <div class="section">
      <div class="sec-t">Company Goals &mdash; Q1 2026</div>
      <p style="font-size:.85rem;color:var(--muted);margin-bottom:16px">Click a company to see detailed goals and progress.</p>
    </div>
    <div class="grid g2" id="company-cards">
      <div class="loading"><div class="loading-spin"></div><br>Loading goals...</div>
    </div>
  </div>

  <!-- Company detail view (shown when clicking a company) -->
  <div class="goal-detail" id="goals-detail">
    <div class="goal-back" onclick="showGoalsOverview()">&larr; All Companies</div>
    <div id="goal-detail-content"></div>
  </div>
</div>

<!-- AGENTS TAB -->
<div class="tab-content" id="tab-agents">
  <p style="font-size:.85rem;color:var(--muted);margin-bottom:16px">Agent status updated every 30 minutes by Operations Commander.</p>
  <div class="card" id="agents-list">
    <div class="loading"><div class="loading-spin"></div><br>Loading agents...</div>
  </div>
</div>

<!-- APPROVALS TAB -->
<div class="tab-content" id="tab-approvals">
  <div class="section">
    <div class="sec-t">Pending Approvals</div>
    <p style="font-size:.85rem;color:var(--muted);margin-bottom:16px">Items waiting for your review before agents can proceed.</p>
    <div id="approvals-list">
      <div class="loading"><div class="loading-spin"></div><br>Loading approvals...</div>
    </div>
  </div>
  <div class="section">
    <div class="sec-t" style="font-size:.95rem">Recent Decisions</div>
    <div id="approvals-history">
      <div style="font-size:.85rem;color:var(--muted);padding:12px 0">No recent decisions.</div>
    </div>
  </div>
</div>

<!-- TASKS TAB (for VAs) -->
<div class="tab-content" id="tab-tasks">
  <div class="section">
    <div class="sec-t">Your Tasks</div>
    <p style="font-size:.85rem;color:var(--muted);margin-bottom:16px">Tasks assigned to your role. Complete these and check back for updates.</p>
    <div class="card" id="va-tasks-list">
      <div class="loading"><div class="loading-spin"></div><br>Loading tasks...</div>
    </div>
  </div>
  <div class="section">
    <div class="sec-t" style="font-size:.95rem">Today's Schedule</div>
    <div class="card" id="va-schedule">
      <div style="font-size:.85rem;color:var(--muted)">No schedule data available yet.</div>
    </div>
  </div>
</div>

<!-- SYSTEM TAB -->
<div class="tab-content" id="tab-system">
  <div class="grid g2 section">
    <div class="card">
      <div class="card-t">Infrastructure Health</div>
      <div id="system-health">
        <div class="loading"><div class="loading-spin"></div><br>Loading...</div>
      </div>
    </div>
    <div class="card">
      <div class="card-t">Connection Info</div>
      <div id="connection-info" style="font-size:.85rem;color:var(--muted)">
        <div class="hi"><span>Data source</span><span>status.json via Cloudflare Pages</span></div>
        <div class="hi"><span>Refresh interval</span><span>Every 5 minutes</span></div>
        <div class="hi"><span>Mac Mini pushes</span><span>Every 15 minutes (auto-backup)</span></div>
        <div class="hi"><span>Status generated</span><span>Every 30 minutes (Ops Commander)</span></div>
      </div>
    </div>
  </div>
</div>

<div class="ts">
  <button class="refresh-btn" onclick="loadStatus()">Refresh Now</button>
  <div style="margin-top:8px" id="footer-ts">McFarlin AI Agent System &bull; Web Dashboard</div>
</div>

<script>
// ══════════════════════════════════════════
//  ROLE-BASED DASHBOARD CONFIGURATION
// ══════════════════════════════════════════

const ROLES_CONFIG = {
  roles: {
    admin: {
      label: 'Sean (Admin)',
      entities: 'all',
      agents: 'all',
      sections: ['overview', 'goals', 'agents', 'system', 'approvals', 'tasks'],
      can_switch_roles: true,
      title: 'McFarlin Operations'
    },
    'rdre-marketing': {
      label: 'Amanda (RDRE)',
      entities: ['rdre'],
      agents: [3, 7, 12],
      sections: ['goals', 'approvals', 'overview'],
      can_switch_roles: false,
      title: 'RDRE Marketing Dashboard'
    },
    'bvr-va': {
      label: 'VA (BVR)',
      entities: ['bvr'],
      agents: [2, 6],
      sections: ['tasks', 'overview'],
      can_switch_roles: false,
      title: 'BVR Operations Dashboard'
    }
  },
  users: {
    'rinvest4@gmail.com': 'admin',
    'amandalastudios@gmail.com': 'rdre-marketing'
  },
  agent_entities: {
    operations_commander: ['all'],
    bvr_operations: ['bvr'],
    seo_marketing: ['rdre', 'bvr', 'personal'],
    lead_crm: ['rdre'],
    financial_oversight: ['all'],
    bvr_property_listing: ['bvr'],
    website_content: ['rdre', 'bvr', 'personal'],
    contracts_legal: ['all'],
    process_improvement: ['all'],
    purchasing: ['bvr'],
    it_security: ['all'],
    social_media: ['rdre'],
    email_triage: ['all']
  }
};

const STATUS_URL = 'status.json';
// Embedded status data as fallback when API and static file are unavailable
<<<<<<< HEAD
const EMBEDDED_STATUS = {"generated_at":"2026-02-25T08:30:01.358546","heartbeat":{"timestamp":"2026-02-25T08:30:01.358546","hostname":"Seans-Mac-mini"},"summary":{"active_agents":1,"blocked_agents":7,"disabled_agents":6,"escalations":11,"pending_tasks":69,"completed_tasks":63,"overdue_tasks":10,"due_today":1},"agents":[{"key":"operations_commander","number":1,"name":"Operations Commander","role":"Orchestrator","status":"running","schedule":"every 30 minutes","enabled":true,"wave":"1.1","last_log":"2026-02-25T08:30:01.316557","entities":["all"]},{"key":"bvr_operations","number":2,"name":"BVR Operations","role":"Hostaway + Revenue","status":"next_up","schedule":"every 2 hours (8 AM - 10 PM CT), daily deep at 6 AM","enabled":true,"wave":"1.3","last_log":"2026-02-25T08:30:01.340146","entities":["bvr"]},{"key":"seo_marketing","number":3,"name":"SEO & Marketing","role":"3 sites","status":"wave3","schedule":"daily at 5 AM, weekly deep Mondays","enabled":true,"wave":"3","last_log":null,"entities":["rdre","bvr","personal"]},{"key":"lead_crm","number":4,"name":"Lead & CRM","role":"GHL + Pipedrive","status":"wave2","schedule":"every hour during business hours","enabled":true,"wave":"2.1","last_log":"2026-02-25T07:26:22.903582","entities":["rdre"]},{"key":"financial_oversight","number":5,"name":"Financial Oversight","role":"6 entities","status":"wave2","schedule":"daily at 7 AM, monthly deep on 1st","enabled":true,"wave":"2.2","last_log":"2026-02-25T07:00:26.177655","entities":["all"]},{"key":"bvr_property_listing","number":6,"name":"BVR Property & Listing","role":"Listing management","status":"wave4","schedule":"daily at 8 AM","enabled":true,"wave":"4","last_log":null,"entities":["bvr"]},{"key":"website_content","number":7,"name":"Website & Content","role":"Site monitoring","status":"wave3","schedule":"daily monitoring, continuous for active builds","enabled":true,"wave":"3","last_log":null,"entities":["rdre","bvr","personal"]},{"key":"contracts_legal","number":8,"name":"Contracts & Legal","role":"Document review","status":"disabled","schedule":"on-demand + weekly Fridays + monthly 1st","enabled":false,"wave":"4","last_log":null,"entities":["all"]},{"key":"process_improvement","number":9,"name":"Process Improvement","role":"SOP optimization","status":"disabled","schedule":"weekly Sundays, continuous monitoring","enabled":false,"wave":"4","last_log":null,"entities":["all"]},{"key":"purchasing","number":10,"name":"Purchasing","role":"Supply management","status":"disabled","schedule":"on-demand + daily supply check","enabled":false,"wave":"4","last_log":null,"entities":["bvr"]},{"key":"it_security","number":11,"name":"IT Security","role":"Security monitoring","status":"disabled","schedule":"continuous + weekly deep Sundays","enabled":false,"wave":"4","last_log":"2026-02-25T05:00:20.027528","entities":["all"]},{"key":"social_media","number":12,"name":"Social Media (RDRE)","role":"Content + engagement","status":"wave3","schedule":"daily at 6 AM, weekly Sundays, real-time engagement","enabled":true,"wave":"3","last_log":"2026-02-25T06:00:22.287143","entities":["rdre"]},{"key":"email_triage","number":13,"name":"Email Triage","role":"5 Gmail accounts","status":"disabled","schedule":"Not configured","enabled":false,"wave":"1.2","last_log":"2026-02-25T08:23:54.999887","entities":["all"]},{"key":"bookkeeper","number":14,"name":"Bookkeeper & Accounting","role":"7 entities, QuickBooks","status":"disabled","schedule":"daily at 11 PM, weekly close Sundays, monthly close 1st","enabled":false,"wave":"3","last_log":null,"entities":["all"]}],"escalations":[{"source":"financial/financial-daily-2026-02-25.md","keyword":"urgent"},{"source":"security/security-check-2026-02-25-0500.md","keyword":"error"},{"source":"email-triage/triage-2026-02-24.md","keyword":"error"},{"source":"email-triage/triage-2026-02-25.md","keyword":"error"},{"source":"crm/crm-check-2026-02-25-0726.md","keyword":"error"},{"source":"crm/crm-check-2026-02-24-1524.md","keyword":"error"},{"source":"crm/crm-check-2026-02-25-0325.md","keyword":"error"},{"source":"crm/crm-check-2026-02-24-2325.md","keyword":"error"},{"source":"crm/crm-check-2026-02-24-1925.md","keyword":"error"},{"source":"crm/crm-check-2026-02-24-1124.md","keyword":"error"},{"source":"content/content-daily-2026-02-25.md","keyword":"error"}],"deadlines":[{"text":"Follow up with Provident Loan Servicing if no response to Feb 21 formal escalation \u2014 by March 6. Rem","date":"2026-02-21","days_until":-4,"severity":"high"},{"text":"Follow up with John Marshall (JM Investment Trust / JM Partners LLC) if payoff statement not receive","date":"2026-02-28","days_until":3,"severity":"high"},{"text":"If Provident misses March 6 deadline: escalate \u2014 consider regulatory complaint or legal counsel","date":"2026-03-06","days_until":9,"severity":"medium"},{"text":"**SEARCH ALL EMAIL ACCOUNTS for tax extension confirmations** \u2014 5-6 entities need March 15 filings. ","date":"2026-03-15","days_until":18,"severity":"medium"}],"system_health":{"watchdog":{"status":"warning","detail":"Last check: 06:02 AM"},"auto_backup":{"status":"ok","detail":"Last: 08:15 AM"},"morning_briefing":{"status":"ok","detail":"Sent at 07:00 AM"},"auto_merge":{"status":"ok","detail":"Last: 08:25 AM"},"github_push":{"status":"ok","detail":"Last: 08:15 AM"}},"tasks":{"pending":69,"completed":63,"overdue":10,"due_today":1},"pending_approvals":[],"company_goals":{"description":"Structured company goals for the dashboard. Source of truth synced from goals.yaml. Update quarterly.","last_updated":"2026-02-24","quarter":"Q1 2026","companies":{"rdre":{"name":"Real Deal Real Estate Buyers","short_name":"RDRE","icon":"house","color":"#C8973E","annual_target":"$400K net income","annual_target_amount":400000,"team":["Sean McFarlin","Amanda McFarlin"],"priority":1,"overall_progress":0.3,"status":"on_track","summary":"Strategy complete. GHL automation built. First deal target: March 31.","goals":[{"id":"rdre-lead-automation","name":"GHL Lead Intake Fully Automated","description":"Tags, drip campaigns, auto-response all configured in GHL","target_date":"2026-03-07","progress":0.6,"status":"on_track","milestones":[{"label":"8 workflows built","done":true},{"label":"14 pipeline stages configured","done":true},{"label":"Auto-tagging live","done":false},{"label":"Drip campaigns active","done":false}]},{"id":"rdre-client-journey","name":"Full Client Journey Mapped","description":"Marketing to close process documented end-to-end","target_date":"2026-03-01","progress":1.0,"status":"complete","milestones":[{"label":"Lead flow design complete","done":true},{"label":"Skip tracing process documented","done":true},{"label":"Marketing playbook created","done":true},{"label":"30-90 day roadmap defined","done":true}]},{"id":"rdre-first-deal","name":"First Qualified Deal in Pipeline","description":"At least one qualified seller lead actively being worked","target_date":"2026-03-31","progress":0.0,"status":"on_track","milestones":[{"label":"Marketing campaigns live","done":false},{"label":"First inbound leads","done":false},{"label":"Lead qualified","done":false},{"label":"Offer submitted","done":false}]},{"id":"rdre-amanda-onboarding","name":"Amanda Fully Onboarded","description":"Clear roles defined for marketing + showings","target_date":"2026-02-28","progress":0.7,"status":"on_track","milestones":[{"label":"Strategy session completed","done":true},{"label":"Marketing lead role defined","done":true},{"label":"GHL access configured","done":true},{"label":"Approval workflow live","done":false}]},{"id":"rdre-seller-video","name":"Seller Video/Photo Submission Process","description":"Allow sellers to submit property walk-through videos or photos remotely","target_date":"2026-03-15","progress":0.0,"status":"on_track","milestones":[{"label":"Submission form designed","done":false},{"label":"Upload mechanism built","done":false},{"label":"Integrated with GHL pipeline","done":false}]},{"id":"rdre-website","name":"WordPress Website Live","description":"WordPress site hosted within GHL (GHL's WordPress hosting). CMS is WordPress via GHL \u2014 not a separate WordPress install. GHL stays as the hosting platform.","target_date":"2026-03-31","progress":0.6,"status":"on_track","milestones":[{"label":"7 pages designed on staging","done":true},{"label":"Design system finalized","done":true},{"label":"WordPress deployed via GHL hosting","done":false},{"label":"Go live with domain","done":false}]}]},"bvr":{"name":"Breezy Vacation Rentals","short_name":"BVR","icon":"palmtree","color":"#3b82f6","annual_target":"$240K net income","annual_target_amount":240000,"team":["Sean McFarlin","Joshua (VA)","Dee (VA)","Kristine (VA)"],"priority":2,"overall_progress":0.2,"status":"on_track","summary":"Operations stable. VAs covering 24/7. API connected. Focus: occupancy and expense tracking.","goals":[{"id":"bvr-hostaway-api","name":"Hostaway API Connected & Pulling Data","description":"Live property data flowing from Hostaway into agent system","target_date":"2026-03-01","progress":0.5,"status":"on_track","milestones":[{"label":"API key configured","done":true},{"label":"Agent 2 built with API integration","done":true},{"label":"Deployed and pulling live data","done":false}]},{"id":"bvr-va-sops","name":"All VAs Operating from Documented SOPs","description":"Standard operating procedures documented and followed by all VAs","target_date":"2026-03-15","progress":0.7,"status":"on_track","milestones":[{"label":"BVR SOP reviewed and documented","done":true},{"label":"VA roles defined","done":true},{"label":"SOP compliance tracking","done":false}]},{"id":"bvr-expense-tracking","name":"Expense Tracking Automated","description":"Streamlined expense tracking across all properties","target_date":"2026-03-31","progress":0.0,"status":"on_track","milestones":[{"label":"QuickBooks integration explored","done":false},{"label":"Expense categories defined","done":false},{"label":"Automated reporting","done":false}]},{"id":"bvr-occupancy","name":"Maintain 70%+ Occupancy","description":"Consistent 70%+ occupancy across all ~30 listings","target_date":"2026-12-31","progress":0.5,"status":"on_track","milestones":[{"label":"PriceLabs pricing active","done":true},{"label":"Listing optimization","done":false},{"label":"Seasonal strategy defined","done":false}]}]},"mcfarlin-re":{"name":"McFarlin Real Estate","short_name":"McFarlin RE","icon":"building","color":"#a855f7","annual_target":"$100K net income","annual_target_amount":100000,"team":["Sean McFarlin"],"priority":4,"overall_progress":0.1,"status":"on_track","summary":"Active listing at 12014 Rainforest. Revenue flows from Real Deal and existing business.","goals":[{"id":"mre-current-listing","name":"Close Current Listing","description":"Close 12014 Rainforest sale (target mid-2026)","target_date":"2026-06-30","progress":0.2,"status":"on_track","milestones":[{"label":"Listed and active","done":true},{"label":"Showing inquiries handled","done":true},{"label":"Offer received","done":false},{"label":"Closed","done":false}]},{"id":"mre-brokerage-eval","name":"Evaluate eXp to 100% Brokerage Switch","description":"After current listing closes, evaluate switching to 100% commission brokerage","target_date":"2026-08-31","progress":0.0,"status":"on_track","milestones":[{"label":"Current listing closed","done":false},{"label":"Options researched","done":false},{"label":"Decision made","done":false}]},{"id":"mre-handyman","name":"Handyman Revenue Tracking","description":"Establish tracking for handyman service revenue","target_date":"2026-03-31","progress":0.0,"status":"on_track","milestones":[{"label":"Revenue tracking system set up","done":false},{"label":"Monthly reporting","done":false}]}]},"holdings":{"name":"Holdings Portfolio","short_name":"Holdings","icon":"briefcase","color":"#22c55e","annual_target":"$240K-$290K combined net","annual_target_amount":265000,"team":["Sean McFarlin"],"priority":5,"overall_progress":0.05,"status":"on_track","summary":"Passive income entities. Monitor only. Average Jo, Montgomery Oak, ASH Homes.","entities":["Average Jo Holdings","Montgomery Oak","ASH Homes"],"goals":[{"id":"hold-quickbooks","name":"QuickBooks Reconciled","description":"All entities reconciled in QuickBooks","target_date":"2026-06-30","progress":0.0,"status":"on_track","milestones":[{"label":"QuickBooks API connected","done":false},{"label":"Entities reconciled","done":false}]},{"id":"hold-expense-budgets","name":"Expense Budgets Established","description":"Per-entity expense budgets defined and tracked","target_date":"2026-06-30","progress":0.0,"status":"on_track","milestones":[{"label":"Budget categories defined","done":false},{"label":"Monthly tracking active","done":false}]},{"id":"hold-ltr-eval","name":"LTR Management Evaluation","description":"Evaluate RPM Republic vs RentLife consolidation","target_date":"2026-08-31","progress":0.0,"status":"on_track","milestones":[{"label":"Performance comparison","done":false},{"label":"Decision made","done":false}]}]},"ridgeway":{"name":"115 Ridgeway / Gatsby","short_name":"Ridgeway","icon":"clipboard","color":"#71717a","annual_target":"Close out open items","annual_target_amount":0,"team":["Sean McFarlin"],"priority":6,"overall_progress":0.1,"status":"on_track","summary":"Not growing. Tracking 2 open items: wrap note sale and escrow overpayment.","goals":[{"id":"ridgeway-wrap-note","name":"Wrap Note Sale Closing","description":"Coordinate closing with Alamo Title + Provident Funding","target_date":"2026-03-31","progress":0.3,"status":"on_track","milestones":[{"label":"Payoff statement requested","done":true},{"label":"John Marshall follow-up (Feb 28)","done":false},{"label":"Closing coordinated","done":false}]},{"id":"ridgeway-escrow","name":"Escrow Overpayment Credit","description":"Receive $1,527.51 escrow overcharge credit from Provident","target_date":"2026-03-06","progress":0.2,"status":"at_risk","milestones":[{"label":"Formal escalation sent (Feb 21)","done":true},{"label":"Provident response by Mar 6","done":false},{"label":"Credit received","done":false}]}]}},"role_visibility":{"admin":["rdre","bvr","mcfarlin-re","holdings","ridgeway"],"rdre-marketing":["rdre"],"bvr-va":["bvr"]}}};
=======
const EMBEDDED_STATUS = {"generated_at":"2026-02-25T14:20:47.949738","heartbeat":{"timestamp":"2026-02-25T14:20:47.949738","hostname":"Seans-Mac-mini"},"summary":{"active_agents":1,"blocked_agents":7,"disabled_agents":6,"escalations":0,"pending_tasks":69,"completed_tasks":63,"overdue_tasks":10,"due_today":1},"agents":[{"key":"operations_commander","number":1,"name":"Operations Commander","role":"Orchestrator","status":"running","schedule":"every 30 minutes","enabled":true,"wave":"1.1","last_log":"2026-02-25T14:19:39.432628","entities":["all"]},{"key":"bvr_operations","number":2,"name":"BVR Operations","role":"Hostaway + Revenue","status":"next_up","schedule":"every 2 hours (8 AM - 10 PM CT), daily deep at 6 AM","enabled":true,"wave":"1.3","last_log":null,"entities":["bvr"]},{"key":"seo_marketing","number":3,"name":"SEO & Marketing","role":"3 sites","status":"wave3","schedule":"daily at 5 AM, weekly deep Mondays","enabled":true,"wave":"3","last_log":null,"entities":["rdre","bvr","personal"]},{"key":"lead_crm","number":4,"name":"Lead & CRM","role":"GHL + Pipedrive","status":"wave2","schedule":"every hour during business hours","enabled":true,"wave":"2.1","last_log":null,"entities":["rdre"]},{"key":"financial_oversight","number":5,"name":"Financial Oversight","role":"6 entities","status":"wave2","schedule":"daily at 7 AM, monthly deep on 1st","enabled":true,"wave":"2.2","last_log":null,"entities":["all"]},{"key":"bvr_property_listing","number":6,"name":"BVR Property & Listing","role":"Listing management","status":"wave4","schedule":"daily at 8 AM","enabled":true,"wave":"4","last_log":null,"entities":["bvr"]},{"key":"website_content","number":7,"name":"Website & Content","role":"Site monitoring","status":"wave3","schedule":"daily monitoring, continuous for active builds","enabled":true,"wave":"3","last_log":null,"entities":["rdre","bvr","personal"]},{"key":"contracts_legal","number":8,"name":"Contracts & Legal","role":"Document review","status":"disabled","schedule":"on-demand + weekly Fridays + monthly 1st","enabled":false,"wave":"4","last_log":null,"entities":["all"]},{"key":"process_improvement","number":9,"name":"Process Improvement","role":"SOP optimization","status":"disabled","schedule":"weekly Sundays, continuous monitoring","enabled":false,"wave":"4","last_log":null,"entities":["all"]},{"key":"purchasing","number":10,"name":"Purchasing","role":"Supply management","status":"disabled","schedule":"on-demand + daily supply check","enabled":false,"wave":"4","last_log":null,"entities":["bvr"]},{"key":"it_security","number":11,"name":"IT Security","role":"Security monitoring","status":"disabled","schedule":"continuous + weekly deep Sundays","enabled":false,"wave":"4","last_log":null,"entities":["all"]},{"key":"social_media","number":12,"name":"Social Media (RDRE)","role":"Content + engagement","status":"wave3","schedule":"daily at 6 AM, weekly Sundays, real-time engagement","enabled":true,"wave":"3","last_log":null,"entities":["rdre"]},{"key":"email_triage","number":13,"name":"Email Triage","role":"5 Gmail accounts","status":"disabled","schedule":"Not configured","enabled":false,"wave":"1.2","last_log":null,"entities":["all"]},{"key":"bookkeeper","number":14,"name":"Bookkeeper & Accounting","role":"7 entities, QuickBooks","status":"disabled","schedule":"daily at 11 PM, weekly close Sundays, monthly close 1st","enabled":false,"wave":"3","last_log":null,"entities":["all"]}],"escalations":[],"deadlines":[{"text":"Follow up with Provident Loan Servicing if no response to Feb 21 formal escalation \u2014 by March 6. Rem","date":"2026-02-21","days_until":-4,"severity":"high"},{"text":"Follow up with John Marshall (JM Investment Trust / JM Partners LLC) if payoff statement not receive","date":"2026-02-28","days_until":3,"severity":"high"},{"text":"If Provident misses March 6 deadline: escalate \u2014 consider regulatory complaint or legal counsel","date":"2026-03-06","days_until":9,"severity":"medium"},{"text":"**SEARCH ALL EMAIL ACCOUNTS for tax extension confirmations** \u2014 5-6 entities need March 15 filings. ","date":"2026-03-15","days_until":18,"severity":"medium"}],"system_health":{"watchdog":{"status":"ok","detail":"Last check: 02:19 PM"},"auto_backup":{"status":"ok","detail":"Last: 02:19 PM"},"morning_briefing":{"status":"ok","detail":"Sent at 02:19 PM"},"auto_merge":{"status":"warning","detail":"Check launchd"},"github_push":{"status":"ok","detail":"Last: 02:19 PM"}},"tasks":{"pending":69,"completed":63,"overdue":10,"due_today":1},"pending_approvals":[],"company_goals":{"description":"Structured company goals for the dashboard. Source of truth synced from goals.yaml. Update quarterly.","last_updated":"2026-02-24","quarter":"Q1 2026","companies":{"rdre":{"name":"Real Deal Real Estate Buyers","short_name":"RDRE","icon":"house","color":"#C8973E","annual_target":"$400K net income","annual_target_amount":400000,"team":["Sean McFarlin","Amanda McFarlin"],"priority":1,"overall_progress":0.3,"status":"on_track","summary":"Strategy complete. GHL automation built. First deal target: March 31.","goals":[{"id":"rdre-lead-automation","name":"GHL Lead Intake Fully Automated","description":"Tags, drip campaigns, auto-response all configured in GHL","target_date":"2026-03-07","progress":0.6,"status":"on_track","milestones":[{"label":"8 workflows built","done":true},{"label":"14 pipeline stages configured","done":true},{"label":"Auto-tagging live","done":false},{"label":"Drip campaigns active","done":false}]},{"id":"rdre-client-journey","name":"Full Client Journey Mapped","description":"Marketing to close process documented end-to-end","target_date":"2026-03-01","progress":1.0,"status":"complete","milestones":[{"label":"Lead flow design complete","done":true},{"label":"Skip tracing process documented","done":true},{"label":"Marketing playbook created","done":true},{"label":"30-90 day roadmap defined","done":true}]},{"id":"rdre-first-deal","name":"First Qualified Deal in Pipeline","description":"At least one qualified seller lead actively being worked","target_date":"2026-03-31","progress":0.0,"status":"on_track","milestones":[{"label":"Marketing campaigns live","done":false},{"label":"First inbound leads","done":false},{"label":"Lead qualified","done":false},{"label":"Offer submitted","done":false}]},{"id":"rdre-amanda-onboarding","name":"Amanda Fully Onboarded","description":"Clear roles defined for marketing + showings","target_date":"2026-02-28","progress":0.7,"status":"on_track","milestones":[{"label":"Strategy session completed","done":true},{"label":"Marketing lead role defined","done":true},{"label":"GHL access configured","done":true},{"label":"Approval workflow live","done":false}]},{"id":"rdre-seller-video","name":"Seller Video/Photo Submission Process","description":"Allow sellers to submit property walk-through videos or photos remotely","target_date":"2026-03-15","progress":0.0,"status":"on_track","milestones":[{"label":"Submission form designed","done":false},{"label":"Upload mechanism built","done":false},{"label":"Integrated with GHL pipeline","done":false}]},{"id":"rdre-website","name":"WordPress Website Live","description":"WordPress site hosted within GHL (GHL's WordPress hosting). CMS is WordPress via GHL \u2014 not a separate WordPress install. GHL stays as the hosting platform.","target_date":"2026-03-31","progress":0.6,"status":"on_track","milestones":[{"label":"7 pages designed on staging","done":true},{"label":"Design system finalized","done":true},{"label":"WordPress deployed via GHL hosting","done":false},{"label":"Go live with domain","done":false}]}]},"bvr":{"name":"Breezy Vacation Rentals","short_name":"BVR","icon":"palmtree","color":"#3b82f6","annual_target":"$240K net income","annual_target_amount":240000,"team":["Sean McFarlin","Joshua (VA)","Dee (VA)","Kristine (VA)"],"priority":2,"overall_progress":0.2,"status":"on_track","summary":"Operations stable. VAs covering 24/7. API connected. Focus: occupancy and expense tracking.","goals":[{"id":"bvr-hostaway-api","name":"Hostaway API Connected & Pulling Data","description":"Live property data flowing from Hostaway into agent system","target_date":"2026-03-01","progress":0.5,"status":"on_track","milestones":[{"label":"API key configured","done":true},{"label":"Agent 2 built with API integration","done":true},{"label":"Deployed and pulling live data","done":false}]},{"id":"bvr-va-sops","name":"All VAs Operating from Documented SOPs","description":"Standard operating procedures documented and followed by all VAs","target_date":"2026-03-15","progress":0.7,"status":"on_track","milestones":[{"label":"BVR SOP reviewed and documented","done":true},{"label":"VA roles defined","done":true},{"label":"SOP compliance tracking","done":false}]},{"id":"bvr-expense-tracking","name":"Expense Tracking Automated","description":"Streamlined expense tracking across all properties","target_date":"2026-03-31","progress":0.0,"status":"on_track","milestones":[{"label":"QuickBooks integration explored","done":false},{"label":"Expense categories defined","done":false},{"label":"Automated reporting","done":false}]},{"id":"bvr-occupancy","name":"Maintain 70%+ Occupancy","description":"Consistent 70%+ occupancy across all ~30 listings","target_date":"2026-12-31","progress":0.5,"status":"on_track","milestones":[{"label":"PriceLabs pricing active","done":true},{"label":"Listing optimization","done":false},{"label":"Seasonal strategy defined","done":false}]}]},"mcfarlin-re":{"name":"McFarlin Real Estate","short_name":"McFarlin RE","icon":"building","color":"#a855f7","annual_target":"$100K net income","annual_target_amount":100000,"team":["Sean McFarlin"],"priority":4,"overall_progress":0.1,"status":"on_track","summary":"Active listing at 12014 Rainforest. Revenue flows from Real Deal and existing business.","goals":[{"id":"mre-current-listing","name":"Close Current Listing","description":"Close 12014 Rainforest sale (target mid-2026)","target_date":"2026-06-30","progress":0.2,"status":"on_track","milestones":[{"label":"Listed and active","done":true},{"label":"Showing inquiries handled","done":true},{"label":"Offer received","done":false},{"label":"Closed","done":false}]},{"id":"mre-brokerage-eval","name":"Evaluate eXp to 100% Brokerage Switch","description":"After current listing closes, evaluate switching to 100% commission brokerage","target_date":"2026-08-31","progress":0.0,"status":"on_track","milestones":[{"label":"Current listing closed","done":false},{"label":"Options researched","done":false},{"label":"Decision made","done":false}]},{"id":"mre-handyman","name":"Handyman Revenue Tracking","description":"Establish tracking for handyman service revenue","target_date":"2026-03-31","progress":0.0,"status":"on_track","milestones":[{"label":"Revenue tracking system set up","done":false},{"label":"Monthly reporting","done":false}]}]},"holdings":{"name":"Holdings Portfolio","short_name":"Holdings","icon":"briefcase","color":"#22c55e","annual_target":"$240K-$290K combined net","annual_target_amount":265000,"team":["Sean McFarlin"],"priority":5,"overall_progress":0.05,"status":"on_track","summary":"Passive income entities. Monitor only. Average Jo, Montgomery Oak, ASH Homes.","entities":["Average Jo Holdings","Montgomery Oak","ASH Homes"],"goals":[{"id":"hold-quickbooks","name":"QuickBooks Reconciled","description":"All entities reconciled in QuickBooks","target_date":"2026-06-30","progress":0.0,"status":"on_track","milestones":[{"label":"QuickBooks API connected","done":false},{"label":"Entities reconciled","done":false}]},{"id":"hold-expense-budgets","name":"Expense Budgets Established","description":"Per-entity expense budgets defined and tracked","target_date":"2026-06-30","progress":0.0,"status":"on_track","milestones":[{"label":"Budget categories defined","done":false},{"label":"Monthly tracking active","done":false}]},{"id":"hold-ltr-eval","name":"LTR Management Evaluation","description":"Evaluate RPM Republic vs RentLife consolidation","target_date":"2026-08-31","progress":0.0,"status":"on_track","milestones":[{"label":"Performance comparison","done":false},{"label":"Decision made","done":false}]}]},"ridgeway":{"name":"115 Ridgeway / Gatsby","short_name":"Ridgeway","icon":"clipboard","color":"#71717a","annual_target":"Close out open items","annual_target_amount":0,"team":["Sean McFarlin"],"priority":6,"overall_progress":0.1,"status":"on_track","summary":"Not growing. Tracking 2 open items: wrap note sale and escrow overpayment.","goals":[{"id":"ridgeway-wrap-note","name":"Wrap Note Sale Closing","description":"Coordinate closing with Alamo Title + Provident Funding","target_date":"2026-03-31","progress":0.3,"status":"on_track","milestones":[{"label":"Payoff statement requested","done":true},{"label":"John Marshall follow-up (Feb 28)","done":false},{"label":"Closing coordinated","done":false}]},{"id":"ridgeway-escrow","name":"Escrow Overpayment Credit","description":"Receive $1,527.51 escrow overcharge credit from Provident","target_date":"2026-03-06","progress":0.2,"status":"at_risk","milestones":[{"label":"Formal escalation sent (Feb 21)","done":true},{"label":"Provident response by Mar 6","done":false},{"label":"Credit received","done":false}]}]}},"role_visibility":{"admin":["rdre","bvr","mcfarlin-re","holdings","ridgeway"],"rdre-marketing":["rdre"],"bvr-va":["bvr"]}}};
>>>>>>> e7d8dc27770f672d2d7ef77f328923673b44beeb
let currentData = null;
let currentRole = 'admin'; // default, will be overridden by auth
let actualRole = 'admin';  // the user's real role (for admin switching back)

// ══════════════════════════════════════════
//  ROLE DETECTION & SWITCHING
// ══════════════════════════════════════════

function detectRole() {
  // Priority 1: URL parameter (for dev/testing and admin switching)
  const params = new URLSearchParams(window.location.search);
  const urlRole = params.get('role');
  if (urlRole && ROLES_CONFIG.roles[urlRole]) {
    currentRole = urlRole;
  }

  // Priority 2: Cloudflare Access JWT (production)
  // When Cloudflare Access is configured, it sets a cookie with the user's email.
  // We decode it to determine the role.
  const cfEmail = getCfAccessEmail();
  if (cfEmail) {
    const mappedRole = ROLES_CONFIG.users[cfEmail.toLowerCase()];
    if (mappedRole) {
      actualRole = mappedRole;
      // Only use CF role if no URL override, or if non-admin trying to override
      if (!urlRole) {
        currentRole = mappedRole;
      } else if (mappedRole !== 'admin' && urlRole !== mappedRole) {
        // Non-admin users can't switch roles via URL
        currentRole = mappedRole;
      }
    }
  }

  // Priority 3: localStorage (remembers admin's last viewed role)
  if (!urlRole && !cfEmail) {
    const saved = localStorage.getItem('dashboard-role');
    if (saved && ROLES_CONFIG.roles[saved]) {
      currentRole = saved;
    }
  }
}

function getCfAccessEmail() {
  // Cloudflare Access sets CF_Authorization cookie with a JWT
  // The JWT payload contains the user's email
  try {
    const cookies = document.cookie.split(';');
    for (const cookie of cookies) {
      const [name, value] = cookie.trim().split('=');
      if (name === 'CF_Authorization' && value) {
        // JWT uses base64url encoding: replace - with + and _ with /
        let b64 = value.split('.')[1];
        b64 = b64.replace(/-/g, '+').replace(/_/g, '/');
        // Pad to multiple of 4
        while (b64.length % 4) b64 += '=';
        const payload = JSON.parse(atob(b64));
        return payload.email || null;
      }
    }
  } catch (e) {
    // No CF Access cookie or invalid JWT — that's fine
  }
  return null;
}

function switchRole(role) {
  if (!ROLES_CONFIG.roles[role]) return;
  currentRole = role;
  localStorage.setItem('dashboard-role', role);
  applyRole();
  if (currentData) renderAll(currentData);

  // Update URL without reload
  const url = new URL(window.location);
  if (role === actualRole) {
    url.searchParams.delete('role');
  } else {
    url.searchParams.set('role', role);
  }
  history.replaceState(null, '', url);
}

function applyRole() {
  const role = ROLES_CONFIG.roles[currentRole];
  if (!role) return;

  // Update title
  document.getElementById('dashboard-title').textContent = role.title;

  // Show/hide role switcher (admin only)
  const switcher = document.getElementById('role-switcher');
  if (actualRole === 'admin' || !getCfAccessEmail()) {
    // Show switcher for admin, or when no auth (dev mode)
    switcher.style.display = 'flex';
    const select = document.getElementById('role-select');
    if (select.options.length === 0) {
      for (const [key, r] of Object.entries(ROLES_CONFIG.roles)) {
        const opt = document.createElement('option');
        opt.value = key;
        opt.textContent = r.label;
        select.appendChild(opt);
      }
    }
    select.value = currentRole;
    document.getElementById('role-tag').textContent =
      currentRole === actualRole ? 'Your view' : 'Previewing';
  } else {
    switcher.style.display = 'none';
  }

  // Show/hide tabs based on role sections
  const allowedSections = role.sections;
  document.querySelectorAll('.tab').forEach(tab => {
    const tabId = tab.getAttribute('data-tab');
    tab.style.display = allowedSections.includes(tabId) ? '' : 'none';
  });

  // Make sure active tab is visible, otherwise switch to first allowed
  const activeTab = document.querySelector('.tab.active');
  const activeTabId = activeTab ? activeTab.getAttribute('data-tab') : null;
  if (!activeTabId || !allowedSections.includes(activeTabId)) {
    showTab(allowedSections[0]);
  }

  // Hide heartbeat for non-admin (they don't need to know about Mac Mini)
  const heartbeat = document.getElementById('heartbeat');
  if (currentRole === 'admin') {
    heartbeat.style.display = 'flex';
  } else {
    heartbeat.style.display = 'none';
  }

  // Adjust summary stats for non-admin
  // (they'll be recalculated when data renders)
}

// ══════════════════════════════════════════
//  TAB SWITCHING
// ══════════════════════════════════════════

function showTab(id) {
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  const content = document.getElementById('tab-' + id);
  const tab = document.querySelector('.tab[data-tab="' + id + '"]');
  if (content) content.classList.add('active');
  if (tab) tab.classList.add('active');
}

// ══════════════════════════════════════════
//  AGENT FILTERING
// ══════════════════════════════════════════

function filterAgentsForRole(agents) {
  const role = ROLES_CONFIG.roles[currentRole];
  if (!role || role.agents === 'all') return agents;

  const allowedNumbers = role.agents;
  const allowedEntities = role.entities;

  return agents.filter(a => {
    // Filter by agent number
    if (allowedNumbers.includes(a.number)) return true;

    // Also check entity match
    const agentEntities = ROLES_CONFIG.agent_entities[a.key] || [];
    if (agentEntities.includes('all')) return false; // cross-entity agents only for admin
    return agentEntities.some(e => allowedEntities.includes(e));
  });
}

function filterEscalationsForRole(escalations) {
  const role = ROLES_CONFIG.roles[currentRole];
  if (!role || role.entities === 'all') return escalations;

  const allowedEntities = role.entities;
  return escalations.filter(e => {
    const source = (e.source || '').toLowerCase();
    // Map escalation sources to entities
    if (allowedEntities.includes('rdre') && (source.includes('seo') || source.includes('social') || source.includes('website'))) return true;
    if (allowedEntities.includes('bvr') && (source.includes('bvr') || source.includes('hostaway'))) return true;
    return false;
  });
}

// ══════════════════════════════════════════
//  TIME HELPERS
// ══════════════════════════════════════════

function timeAgo(isoStr) {
  if (!isoStr) return 'Never';
  const diff = (Date.now() - new Date(isoStr).getTime()) / 1000;
  if (diff < 60) return 'Just now';
  if (diff < 3600) return Math.floor(diff / 60) + ' min ago';
  if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
  return Math.floor(diff / 86400) + 'd ago';
}

function formatDate(isoStr) {
  if (!isoStr) return '';
  const d = new Date(isoStr);
  return d.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
}

function formatTime(isoStr) {
  if (!isoStr) return '';
  const d = new Date(isoStr);
  return d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
}

// ══════════════════════════════════════════
//  HEARTBEAT
// ══════════════════════════════════════════

function updateHeartbeat(data) {
  const hb = document.getElementById('heartbeat');
  const dot = document.getElementById('hb-dot');
  const label = document.getElementById('hb-label');
  const detail = document.getElementById('hb-detail');

  if (!data || !data.heartbeat) {
    hb.className = 'hb hb-unknown';
    dot.style.background = 'var(--muted)';
    label.textContent = 'No Data';
    detail.textContent = 'Could not load status.json';
    return;
  }

  const ts = new Date(data.heartbeat.timestamp);
  const diffMin = (Date.now() - ts.getTime()) / 60000;

  if (diffMin < 60) {
    hb.className = 'hb hb-online';
    dot.style.background = 'var(--green)';
    label.textContent = 'Mac Mini Online';
    label.style.color = 'var(--green)';
    detail.textContent = 'Last heartbeat: ' + timeAgo(data.heartbeat.timestamp) + ' \u2022 ' + (data.heartbeat.hostname || '');
  } else if (diffMin < 120) {
    hb.className = 'hb hb-delayed';
    dot.style.background = 'var(--yellow)';
    label.textContent = 'Mac Mini \u2014 Delayed';
    label.style.color = 'var(--yellow)';
    detail.textContent = 'Last heartbeat: ' + Math.floor(diffMin) + ' min ago. May need attention soon.';
  } else {
    hb.className = 'hb hb-offline';
    dot.style.background = 'var(--red)';
    label.textContent = 'MAC MINI OFFLINE';
    label.style.color = 'var(--red)';
    const hours = Math.floor(diffMin / 60);
    detail.textContent = 'Last heartbeat: ' + hours + 'h ago. SSH in and log in to restart agents.';
  }
}

// ══════════════════════════════════════════
//  SUMMARY STATS
// ══════════════════════════════════════════

function updateSummary(data) {
  if (!data || !data.summary) return;

  const role = ROLES_CONFIG.roles[currentRole];

  if (currentRole === 'admin') {
    // Admin sees full stats
    const s = data.summary;
    document.getElementById('summary-stats').innerHTML = `
      <div class="ms"><div class="v" style="color:var(--green)">${s.active_agents}</div><div class="l">Active</div></div>
      <div class="ms"><div class="v" style="color:var(--yellow)">${s.blocked_agents}</div><div class="l">Blocked</div></div>
      <div class="ms"><div class="v" style="color:var(--muted)">${s.disabled_agents}</div><div class="l">Disabled</div></div>
      <div class="ms"><div class="v" style="color:var(--red)">${s.escalations}</div><div class="l">Escalations</div></div>
    `;
  } else if (currentRole === 'rdre-marketing') {
    // Amanda sees approval-focused stats
    const pending = (data.pending_approvals || []).length;
    const agents = filterAgentsForRole(data.agents || []);
    const activeAgents = agents.filter(a => a.status === 'running').length;
    document.getElementById('summary-stats').innerHTML = `
      <div class="ms"><div class="v" style="color:var(--yellow)">${pending}</div><div class="l">Pending</div></div>
      <div class="ms"><div class="v" style="color:var(--green)">${activeAgents}</div><div class="l">Agents</div></div>
      <div class="ms"><div class="v" style="color:var(--blue)">${agents.length}</div><div class="l">Your Agents</div></div>
    `;
  } else if (currentRole === 'bvr-va') {
    // VAs see task-focused stats
    const t = data.tasks || {};
    document.getElementById('summary-stats').innerHTML = `
      <div class="ms"><div class="v" style="color:var(--yellow)">${t.pending || 0}</div><div class="l">Open Tasks</div></div>
      <div class="ms"><div class="v" style="color:var(--green)">${t.completed || 0}</div><div class="l">Done</div></div>
      <div class="ms"><div class="v" style="color:var(--red)">${t.overdue || 0}</div><div class="l">Overdue</div></div>
    `;
  }

  document.getElementById('date-line').textContent = formatDate(data.generated_at) +
    ' \u2022 Updated ' + timeAgo(data.generated_at);
}

// ══════════════════════════════════════════
//  ESCALATIONS
// ══════════════════════════════════════════

function updateEscalations(data) {
  const section = document.getElementById('escalations-section');
  const list = document.getElementById('escalations-list');
  if (!data || !data.escalations) {
    section.style.display = 'none';
    return;
  }

  const filtered = currentRole === 'admin' ? data.escalations : filterEscalationsForRole(data.escalations);

  if (filtered.length === 0) {
    section.style.display = 'none';
    return;
  }
  section.style.display = 'block';
  list.innerHTML = filtered.map(e => `
    <div class="esc">
      <div class="esc-t">${escHtml(e.source || e.title || 'Alert')}</div>
      <div class="esc-d">Keyword: ${escHtml(e.keyword || e.detail || '')}</div>
    </div>
  `).join('');
}

// ══════════════════════════════════════════
//  DEADLINES
// ══════════════════════════════════════════

function updateDeadlines(data) {
  const el = document.getElementById('deadlines-list');
  if (!data || !data.deadlines || data.deadlines.length === 0) {
    el.innerHTML = '<div style="font-size:.85rem;color:var(--muted);padding:12px 0">No upcoming deadlines.</div>';
    return;
  }

  // For non-admin roles, show a simplified view
  const deadlines = currentRole === 'admin' ? data.deadlines : data.deadlines.slice(0, 3);

  el.innerHTML = deadlines.map(d => {
    const color = d.severity === 'high' ? 'var(--red)' : d.severity === 'medium' ? 'var(--yellow)' : 'var(--muted)';
    const days = d.days_until;
    const label = days < 0 ? Math.abs(days) + 'd overdue' : days === 0 ? 'TODAY' : days + 'd';
    return `<div class="dl">
      <span style="color:${color};font-weight:${d.severity==='high'?600:400}">${escHtml(d.text)}</span>
      <span class="badge ${d.severity==='high'?'br':d.severity==='medium'?'by':'bb'}" style="flex-shrink:0">${label}</span>
    </div>`;
  }).join('');
}

// ══════════════════════════════════════════
//  TASKS
// ══════════════════════════════════════════

function updateTasks(data) {
  const el = document.getElementById('tasks-summary');
  if (!data || !data.tasks) {
    el.innerHTML = '<div style="color:var(--muted)">No task data</div>';
    return;
  }
  const t = data.tasks;
  const total = t.pending + t.completed;
  const pct = total > 0 ? Math.round((t.completed / total) * 100) : 0;
  el.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:baseline;margin-bottom:8px">
      <div><span style="font-size:1.5rem;font-weight:700">${t.pending}</span> <span style="font-size:.8rem;color:var(--muted)">open</span></div>
      <div><span style="font-size:1.5rem;font-weight:700;color:var(--green)">${t.completed}</span> <span style="font-size:.8rem;color:var(--muted)">done</span></div>
    </div>
    <div class="pb"><div class="pf" style="width:${pct}%;background:var(--green)"></div></div>
    <div style="font-size:.75rem;color:var(--muted);margin-top:6px">${pct}% completion rate${t.overdue > 0 ? ' \u2022 <span style=\"color:var(--red)\">' + t.overdue + ' overdue</span>' : ''}</div>
  `;
}

// ══════════════════════════════════════════
//  AGENTS
// ══════════════════════════════════════════

function updateAgents(data) {
  const el = document.getElementById('agents-list');
  if (!data || !data.agents) {
    el.innerHTML = '<div style="color:var(--muted);padding:12px">No agent data</div>';
    return;
  }

  const agents = filterAgentsForRole(data.agents);

  if (agents.length === 0) {
    el.innerHTML = '<div style="color:var(--muted);padding:12px">No agents assigned to your role.</div>';
    return;
  }

  el.innerHTML = agents.map(a => {
    const statusMap = {
      running: { badge: 'bg', label: 'Running', dot: 'dg', numBg: 'var(--gbg)', numColor: 'var(--green)' },
      next_up: { badge: 'by', label: 'Next Up', dot: 'dy', numBg: 'var(--ybg)', numColor: 'var(--yellow)' },
      partial: { badge: 'bb', label: 'Partial', dot: 'db', numBg: 'var(--bbg)', numColor: 'var(--blue)' },
      wave2: { badge: 'by', label: 'Wave 2', dot: 'dy', numBg: 'var(--ybg)', numColor: 'var(--yellow)' },
      wave3: { badge: 'by', label: 'Wave 3', dot: 'dy', numBg: 'var(--ybg)', numColor: 'var(--yellow)' },
      wave4: { badge: 'bp', label: 'Wave 4', dot: 'dp', numBg: 'var(--border)', numColor: 'var(--muted)' },
      disabled: { badge: 'bp', label: 'Disabled', dot: 'dp', numBg: 'var(--border)', numColor: 'var(--muted)' },
    };
    const s = statusMap[a.status] || statusMap.disabled;
    const lastRun = a.last_log ? 'Last: ' + timeAgo(a.last_log) : 'No logs yet';

    return `<div class="ar">
      <div class="ar-main">
        <div class="ar-left">
          <div class="anum" style="background:${s.numBg};color:${s.numColor}">${a.number}</div>
          <div style="min-width:0">
            <div class="aname">${escHtml(a.name)}</div>
            <div class="adet">${escHtml(a.role)} \u2022 ${escHtml(a.schedule)} \u2022 ${lastRun}</div>
          </div>
        </div>
        <span class="badge ${s.badge}"><span class="dot ${s.dot}"></span> ${s.label}</span>
      </div>
    </div>`;
  }).join('');
}

// ══════════════════════════════════════════
//  APPROVALS (Amanda's primary interface)
// ══════════════════════════════════════════

function updateApprovals(data) {
  const el = document.getElementById('approvals-list');

  // Pending approvals come from status.json (generated by the Python script)
  const approvals = data.pending_approvals || [];

  if (approvals.length === 0) {
    el.innerHTML = `
      <div class="empty-state">
        <div class="emoji">&#10003;</div>
        <div class="msg">All caught up!</div>
        <div class="detail">No items waiting for your approval. Agents will notify you when something needs review.</div>
      </div>
    `;
    return;
  }

  el.innerHTML = approvals.map((item, i) => `
    <div class="approval-item">
      <div class="ai-header">
        <div class="ai-title">${escHtml(item.title || 'Pending Item')}</div>
        <span class="badge by">${escHtml(item.agent || 'Agent')}</span>
      </div>
      <div class="ai-desc">${escHtml(item.description || '')}</div>
      <div class="ai-actions">
        <button class="btn btn-approve" onclick="handleApproval(${i}, 'approve')">Approve</button>
        <button class="btn btn-reject" onclick="handleApproval(${i}, 'reject')">Reject</button>
        <button class="btn btn-view" onclick="handleApproval(${i}, 'view')">View Details</button>
      </div>
    </div>
  `).join('');
}

async function handleApproval(index, action) {
  const approvals = currentData.pending_approvals || [];
  const item = approvals[index];
  if (!item) return;

  if (action === 'view') {
    // Show details in a simple modal-style overlay
    const detail = item.description || 'No additional details available.';
    alert('Details for: ' + item.title + '\n\n' + detail + '\n\nFile: ' + (item.file || 'N/A'));
    return;
  }

  const note = prompt((action === 'approve' ? 'Approve' : 'Reject') + ' "' + item.title + '"?\n\nOptional note:');
  if (note === null) return; // cancelled

  try {
    const resp = await fetch('/api/approve', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id: item.id, action, note }),
    });
    const result = await resp.json();

    if (result.ok) {
      // Remove from local data and re-render
      currentData.pending_approvals.splice(index, 1);
      updateApprovals(currentData);
      updateSummary(currentData);
    } else {
      alert('Error: ' + (result.error || 'Unknown error'));
    }
  } catch (err) {
    // API not available yet (static hosting) — fall back to local-only
    console.warn('Approval API not available, recording locally:', err.message);
    currentData.pending_approvals.splice(index, 1);
    updateApprovals(currentData);
    updateSummary(currentData);
    // Store decision in localStorage as backup
    const decisions = JSON.parse(localStorage.getItem('approval-decisions') || '[]');
    decisions.push({ id: item.id, action, note, at: new Date().toISOString() });
    localStorage.setItem('approval-decisions', JSON.stringify(decisions));
  }
}

// ══════════════════════════════════════════
//  VA TASKS
// ══════════════════════════════════════════

function updateVaTasks(data) {
  const el = document.getElementById('va-tasks-list');

  // VA tasks will come from status.json once we add entity-filtered tasks
  const tasks = data.va_tasks || [];

  if (tasks.length === 0) {
    el.innerHTML = `
      <div class="empty-state">
        <div class="emoji">&#128203;</div>
        <div class="msg">No specific tasks assigned</div>
        <div class="detail">Check Hostaway for guest messages and follow the BVR SOP for daily operations.</div>
      </div>
    `;
    return;
  }

  el.innerHTML = tasks.map(t => {
    const priorityColor = t.priority === 'high' ? 'var(--red)' : t.priority === 'medium' ? 'var(--yellow)' : 'var(--green)';
    return `<div class="task-item">
      <div style="display:flex;align-items:center">
        <div class="task-priority" style="background:${priorityColor}"></div>
        <span>${escHtml(t.text || t.title || 'Task')}</span>
      </div>
      <span class="badge ${t.priority === 'high' ? 'br' : t.priority === 'medium' ? 'by' : 'bg'}">${escHtml(t.priority || 'normal')}</span>
    </div>`;
  }).join('');
}

// ══════════════════════════════════════════
//  SYSTEM HEALTH
// ══════════════════════════════════════════

function updateSystemHealth(data) {
  const el = document.getElementById('system-health');
  if (!data || !data.system_health) {
    el.innerHTML = '<div style="color:var(--muted)">No health data</div>';
    return;
  }

  const nameMap = {
    watchdog: 'Watchdog',
    auto_backup: 'Auto-Backup',
    morning_briefing: 'Morning Briefing',
    auto_merge: 'Auto-Merge',
    github_push: 'GitHub Push',
  };

  const h = data.system_health;
  el.innerHTML = Object.keys(h).map(key => {
    const item = h[key];
    const statusClass = item.status === 'ok' ? 'bg' : item.status === 'error' ? 'br' : 'by';
    const dotClass = item.status === 'ok' ? 'dg' : item.status === 'error' ? 'dr' : 'dy';
    const label = item.status === 'ok' ? 'OK' : item.status === 'error' ? 'Error' : 'Warning';
    return `<div class="hi">
      <span>${nameMap[key] || key}</span>
      <span class="badge ${statusClass}"><span class="dot ${dotClass}"></span> ${escHtml(item.detail || label)}</span>
    </div>`;
  }).join('');
}

// ══════════════════════════════════════════
//  HTML ESCAPING
// ══════════════════════════════════════════

function escHtml(str) {
  if (!str) return '';
  const d = document.createElement('div');
  d.textContent = str;
  return d.innerHTML;
}

// ══════════════════════════════════════════
//  GOALS — Company Cards + Detail Drill-down
// ══════════════════════════════════════════

const COMPANY_ICONS = {
  house: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>',
  palmtree: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 8c0-2.76-2.46-5-5.5-5S2 5.24 2 8h2l1-1 1 1h4"/><path d="M13 7.14A5.82 5.82 0 0 1 16.5 6c3.04 0 5.5 2.24 5.5 5h-3l-1-1-1 1h-4"/><path d="M5.89 9.71c-2.15 2.15-2.3 5.47-.35 7.43l4.24-4.25.7-.7.71-.71 4.24-4.24c1.96 1.96 1.8 5.28-.35 7.43"/><path d="M12 20v-6"/></svg>',
  building: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="4" y="2" width="16" height="20" rx="2" ry="2"/><path d="M9 22v-4h6v4"/><path d="M8 6h.01"/><path d="M16 6h.01"/><path d="M12 6h.01"/><path d="M12 10h.01"/><path d="M12 14h.01"/><path d="M16 10h.01"/><path d="M16 14h.01"/><path d="M8 10h.01"/><path d="M8 14h.01"/></svg>',
  briefcase: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>',
  clipboard: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg>'
};

let goalsData = null;

function loadGoalsData(statusData) {
  // Goals come from status.json (generated by Python script which reads company-goals.json)
  if (statusData && statusData.company_goals) {
    goalsData = statusData.company_goals;
  }
}

function getVisibleCompanies() {
  if (!goalsData || !goalsData.companies) return [];
  const role = ROLES_CONFIG.roles[currentRole];
  const roleVisibility = goalsData.role_visibility || {};
  const allowedKeys = roleVisibility[currentRole] || Object.keys(goalsData.companies);
  return allowedKeys
    .filter(key => goalsData.companies[key])
    .map(key => ({ key, ...goalsData.companies[key] }));
}

function statusBadge(status) {
  const map = {
    on_track: { cls: 'bg', label: 'On Track' },
    at_risk: { cls: 'by', label: 'At Risk' },
    behind: { cls: 'br', label: 'Behind' },
    complete: { cls: 'bp', label: 'Complete' },
  };
  const s = map[status] || map.on_track;
  return `<span class="badge ${s.cls}">${s.label}</span>`;
}

function progressColor(progress) {
  if (progress >= 0.7) return 'var(--green)';
  if (progress >= 0.4) return 'var(--blue)';
  if (progress >= 0.2) return 'var(--yellow)';
  return 'var(--muted)';
}

function updateGoals() {
  const el = document.getElementById('company-cards');
  const companies = getVisibleCompanies();

  if (companies.length === 0) {
    el.innerHTML = `
      <div class="empty-state" style="grid-column:1/-1">
        <div class="msg">No goals data available yet.</div>
        <div class="detail">Goals will appear here once the status generator includes company goal data.</div>
      </div>
    `;
    return;
  }

  el.innerHTML = companies.map(c => {
    const pct = Math.round((c.overall_progress || 0) * 100);
    const goals = c.goals || [];
    const completedGoals = goals.filter(g => g.status === 'complete').length;
    const icon = COMPANY_ICONS[c.icon] || COMPANY_ICONS.briefcase;
    const color = c.color || 'var(--blue)';

    return `
      <div class="company-card" onclick="showCompanyDetail('${c.key}')">
        <div class="company-card-accent" style="background:${color}"></div>
        <div class="company-card-header">
          <div class="company-card-icon" style="background:${color}22;color:${color}">${icon}</div>
          <div class="company-card-info">
            <div class="company-card-name">${escHtml(c.short_name || c.name)}</div>
            <div class="company-card-target">${escHtml(c.annual_target)}</div>
          </div>
          ${statusBadge(c.status)}
        </div>
        <div class="company-card-summary">${escHtml(c.summary)}</div>
        <div class="company-card-stats">
          <div class="company-card-stat">
            <div class="v" style="color:${color}">${goals.length}</div>
            <div class="l">Goals</div>
          </div>
          <div class="company-card-stat">
            <div class="v" style="color:var(--green)">${completedGoals}</div>
            <div class="l">Done</div>
          </div>
          <div class="company-card-stat">
            <div class="v">${pct}%</div>
            <div class="l">Progress</div>
          </div>
        </div>
        <div class="company-card-progress">
          <div class="pb"><div class="pf" style="width:${pct}%;background:${color}"></div></div>
          <div class="company-card-progress-label">
            <span>P${c.priority || ''}</span>
            <span>${pct}% overall</span>
          </div>
        </div>
      </div>
    `;
  }).join('');
}

function showCompanyDetail(companyKey) {
  if (!goalsData || !goalsData.companies[companyKey]) return;

  const c = goalsData.companies[companyKey];
  const overview = document.getElementById('goals-overview');
  const detail = document.getElementById('goals-detail');
  const content = document.getElementById('goal-detail-content');

  const pct = Math.round((c.overall_progress || 0) * 100);
  const color = c.color || 'var(--blue)';
  const icon = COMPANY_ICONS[c.icon] || COMPANY_ICONS.briefcase;
  const goals = c.goals || [];

  let html = `
    <div class="goal-company-header">
      <div class="company-card-icon" style="background:${color}22;color:${color};width:48px;height:48px;font-size:1.4rem">${icon}</div>
      <div>
        <div class="goal-company-title">${escHtml(c.name)}</div>
        <div class="goal-company-meta">${escHtml(c.annual_target)} &bull; ${escHtml(c.summary)}</div>
      </div>
    </div>
  `;

  // Annual target progress bar
  if (c.annual_target_amount > 0) {
    html += `
      <div class="annual-target">
        <div class="annual-target-header">
          <div class="annual-target-title">Annual Target</div>
          <div class="annual-target-amount" style="color:${color}">${escHtml(c.annual_target)}</div>
        </div>
        <div class="pb" style="height:10px"><div class="pf" style="width:${pct}%;background:${color}"></div></div>
        <div class="annual-target-labels">
          <span>${pct}% progress</span>
          <span>${escHtml(c.annual_target)}</span>
        </div>
      </div>
    `;
  }

  // Team
  if (c.team && c.team.length > 0) {
    html += `<div style="margin-bottom:16px;font-size:.8rem;color:var(--muted)">Team: ${c.team.map(t => escHtml(t)).join(', ')}</div>`;
  }

  // Goals list
  html += `<div class="sec-t" style="font-size:1rem">Goals (${goals.length})</div>`;

  goals.forEach(g => {
    const gPct = Math.round((g.progress || 0) * 100);
    const milestones = g.milestones || [];
    const doneMilestones = milestones.filter(m => m.done).length;
    const targetDate = g.target_date ? new Date(g.target_date + 'T00:00:00') : null;
    const daysLeft = targetDate ? Math.ceil((targetDate - new Date()) / 86400000) : null;
    let dateLabel = '';
    if (daysLeft !== null) {
      if (daysLeft < 0) dateLabel = Math.abs(daysLeft) + 'd overdue';
      else if (daysLeft === 0) dateLabel = 'Due today';
      else dateLabel = daysLeft + 'd left';
    }
    const dateSeverity = daysLeft !== null && daysLeft < 0 ? 'br' : daysLeft !== null && daysLeft <= 7 ? 'by' : 'bb';

    html += `
      <div class="goal-item">
        <div class="goal-item-header">
          <div>
            <div class="goal-item-name">${escHtml(g.name)}</div>
            <div class="goal-item-desc">${escHtml(g.description)}</div>
          </div>
          <div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px;flex-shrink:0">
            ${statusBadge(g.status)}
            ${dateLabel ? `<span class="badge ${dateSeverity}">${dateLabel}</span>` : ''}
          </div>
        </div>
        <div class="pb"><div class="pf" style="width:${gPct}%;background:${progressColor(g.progress)}"></div></div>
        <div style="display:flex;justify-content:space-between;font-size:.72rem;color:var(--muted);margin-bottom:10px;margin-top:4px">
          <span>${gPct}% complete</span>
          <span>${doneMilestones}/${milestones.length} milestones</span>
        </div>
        ${milestones.length > 0 ? `
          <div class="goal-milestones">
            ${milestones.map(m => `
              <div class="goal-milestone">
                <div class="goal-milestone-check ${m.done ? 'done' : ''}">${m.done ? '&#10003;' : ''}</div>
                <span class="goal-milestone-label ${m.done ? 'done' : ''}">${escHtml(m.label)}</span>
              </div>
            `).join('')}
          </div>
        ` : ''}
      </div>
    `;
  });

  content.innerHTML = html;
  overview.style.display = 'none';
  detail.classList.add('active');
}

function showGoalsOverview() {
  document.getElementById('goals-overview').style.display = '';
  document.getElementById('goals-detail').classList.remove('active');
}

// ══════════════════════════════════════════
//  RENDER ALL
// ══════════════════════════════════════════

function renderAll(data) {
  loadGoalsData(data);
  updateHeartbeat(data);
  updateSummary(data);
  updateEscalations(data);
  updateDeadlines(data);
  updateTasks(data);
  updateAgents(data);
  updateApprovals(data);
  updateVaTasks(data);
  updateSystemHealth(data);
  updateGoals();
}

// ══════════════════════════════════════════
//  LOAD STATUS
// ══════════════════════════════════════════

function statusAge(d) {
  // Returns age in ms of a status object based on its generated_at field
  if (!d || !d.generated_at) return Infinity;
  return Date.now() - new Date(d.generated_at).getTime();
}

function pickFreshest(a, aLabel, b, bLabel) {
  // Return the data object with the more recent generated_at
  if (!a) return { data: b, source: bLabel };
  if (!b) return { data: a, source: aLabel };
  return statusAge(a) <= statusAge(b)
    ? { data: a, source: aLabel }
    : { data: b, source: bLabel };
}

async function loadStatus() {
  let source = 'embedded';
  try {
    let apiData = null, staticData = null;

    // Try KV-backed API first (real-time)
    try {
      const resp = await fetch('/api/sync?t=' + Date.now());
      if (resp.ok) {
        const text = await resp.text();
        if (text.length > 2 && text.charAt(0) === '{') { apiData = JSON.parse(text); }
      }
    } catch (e) { console.warn('API fetch failed:', e.message); }

    // Try static file
    if (!apiData) {
      try {
        const resp = await fetch(STATUS_URL + '?t=' + Date.now());
        if (resp.ok) {
          const text = await resp.text();
          if (text.length > 2 && text.charAt(0) === '{') { staticData = JSON.parse(text); }
        }
      } catch (e) { console.warn('Static fetch failed:', e.message); }
    }

    // Pick the freshest source: compare fetched data against embedded data.
    // This prevents stale KV data from overriding a newer embedded snapshot.
    let best = pickFreshest(apiData, 'api', staticData, 'static');
    best = pickFreshest(best.data, best.source, EMBEDDED_STATUS, 'embedded');
    let data = best.data;
    source = best.source;

    if (data) {
      currentData = data;
      renderAll(currentData);
      const srcLabel = source === 'api' ? 'live' : source === 'static' ? 'file' : 'cached';
      document.getElementById('footer-ts').textContent =
        'McFarlin AI Agent System \u2022 Last loaded: ' + new Date().toLocaleTimeString() + ' (' + srcLabel + ')';
    }
  } catch (err) {
    console.error('Failed to load status:', err);
  }
}

// ══════════════════════════════════════════
//  INIT
// ══════════════════════════════════════════

// Immediately render embedded data so dashboard is never blank
try {
  detectRole();
  applyRole();
  if (EMBEDDED_STATUS) {
    currentData = EMBEDDED_STATUS;
    renderAll(currentData);
    document.getElementById('footer-ts').textContent =
      'McFarlin AI Agent System \u2022 Loaded from cache';
  }
} catch (e) { console.error('Init render error:', e); }

// Then try to fetch fresh data (will overwrite embedded if successful)
loadStatus();
setInterval(loadStatus, 5 * 60 * 1000);
</script>

</body>
</html>
