<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>McFarlin Operations</title>
<style>
  :root {--bg:#0f1117;--card:#1a1d27;--border:#2a2d3a;--text:#e4e4e7;--muted:#71717a;--green:#22c55e;--gbg:rgba(34,197,94,.12);--red:#ef4444;--rbg:rgba(239,68,68,.12);--yellow:#eab308;--ybg:rgba(234,179,8,.12);--blue:#3b82f6;--bbg:rgba(59,130,246,.12);--purple:#a855f7;--pbg:rgba(168,85,247,.12)}
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:-apple-system,BlinkMacSystemFont,'SF Pro Text',system-ui,sans-serif;background:var(--bg);color:var(--text);line-height:1.5;padding:16px;max-width:1200px;margin:0 auto}
  a{color:var(--blue);text-decoration:none}

  /* Heartbeat banner */
  .hb{padding:12px 16px;border-radius:10px;margin-bottom:16px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px}
  .hb-online{background:var(--gbg);border:1px solid rgba(34,197,94,.3)}
  .hb-delayed{background:var(--ybg);border:1px solid rgba(234,179,8,.3)}
  .hb-offline{background:var(--rbg);border:1px solid rgba(239,68,68,.3);animation:pulse 2s infinite}
  .hb-unknown{background:var(--card);border:1px solid var(--border)}
  @keyframes pulse{0%,100%{opacity:1}50%{opacity:.7}}
  .hb-status{font-weight:700;font-size:.9rem;display:flex;align-items:center;gap:8px}
  .hb-detail{font-size:.75rem;color:var(--muted)}
  .hb-dot{width:10px;height:10px;border-radius:50%;display:inline-block}

  h1{font-size:1.5rem;font-weight:700;margin-bottom:4px}
  .sub{color:var(--muted);font-size:.85rem;margin-bottom:16px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:12px}
  .card-t{font-size:.75rem;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--muted);margin-bottom:12px}
  .grid{display:grid;gap:12px}.g2{grid-template-columns:1fr 1fr}.g3{grid-template-columns:1fr 1fr 1fr}.g4{grid-template-columns:1fr 1fr 1fr 1fr}
  @media(max-width:768px){.g2,.g3,.g4{grid-template-columns:1fr}body{padding:12px}}

  /* Tabs */
  .tabs{display:flex;gap:4px;margin-bottom:16px;border-bottom:1px solid var(--border);padding-bottom:0;overflow-x:auto}
  .tab{padding:10px 20px;font-size:.85rem;font-weight:600;color:var(--muted);cursor:pointer;border-bottom:2px solid transparent;transition:all .2s;white-space:nowrap}
  .tab:hover{color:var(--text)}
  .tab.active{color:var(--blue);border-bottom-color:var(--blue)}
  .tab-content{display:none}.tab-content.active{display:block}

  /* Badges */
  .badge{display:inline-flex;align-items:center;gap:5px;padding:3px 10px;border-radius:20px;font-size:.72rem;font-weight:600}
  .bg{background:var(--gbg);color:var(--green)}.br{background:var(--rbg);color:var(--red)}.by{background:var(--ybg);color:var(--yellow)}.bb{background:var(--bbg);color:var(--blue)}.bp{background:var(--pbg);color:var(--purple)}
  .dot{width:6px;height:6px;border-radius:50%;display:inline-block}
  .dg{background:var(--green)}.dr{background:var(--red)}.dy{background:var(--yellow)}.db{background:var(--blue)}

  /* Mini stats */
  .hdr{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:16px;flex-wrap:wrap;gap:12px}
  .stats{display:flex;gap:10px;flex-wrap:wrap}
  .ms{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:8px 14px;text-align:center;min-width:80px}
  .ms .v{font-size:1.3rem;font-weight:700}.ms .l{font-size:.75rem;color:var(--muted)}

  /* Agent rows */
  .ar{border-bottom:1px solid var(--border);cursor:pointer;transition:background .15s}
  .ar:last-child{border-bottom:none}
  .ar:hover{background:rgba(59,130,246,.05)}
  .ar-main{display:flex;align-items:center;justify-content:space-between;padding:10px 0;gap:8px}
  .ar-left{display:flex;align-items:center;flex:1;min-width:0}
  .anum{width:28px;height:28px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:.75rem;font-weight:700;margin-right:12px;flex-shrink:0}
  .aname{font-size:.9rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .adet{font-size:.75rem;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

  /* Escalations */
  .esc{padding:12px;background:var(--rbg);border:1px solid rgba(239,68,68,.25);border-radius:8px;margin-bottom:8px}
  .esc:last-child{margin-bottom:0}
  .esc-t{font-size:.85rem;font-weight:600;color:var(--red)}.esc-d{font-size:.75rem;color:var(--muted);margin-top:4px}

  /* Deadlines */
  .dl{padding:6px 0;border-bottom:1px solid var(--border);font-size:.85rem;display:flex;justify-content:space-between;align-items:center;gap:8px}
  .dl:last-child{border-bottom:none}

  /* Progress bar */
  .pb{width:100%;height:6px;background:var(--border);border-radius:3px;margin-top:8px;overflow:hidden}
  .pf{height:100%;border-radius:3px}

  /* Health items */
  .hi{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--border);font-size:.85rem}
  .hi:last-child{border-bottom:none}

  /* Loading / error */
  .loading{text-align:center;padding:40px;color:var(--muted);font-size:.9rem}
  .loading-spin{display:inline-block;width:20px;height:20px;border:2px solid var(--border);border-top-color:var(--blue);border-radius:50%;animation:spin .8s linear infinite;margin-bottom:12px}
  @keyframes spin{to{transform:rotate(360deg)}}

  .section{margin-bottom:16px}
  .sec-t{font-size:1.1rem;font-weight:700;margin-bottom:12px;display:flex;align-items:center;gap:8px}
  .ts{text-align:center;color:var(--muted);font-size:.7rem;margin-top:20px;padding-top:16px;border-top:1px solid var(--border)}
  .refresh-btn{background:var(--card);border:1px solid var(--border);color:var(--muted);padding:4px 12px;border-radius:6px;font-size:.75rem;cursor:pointer;transition:all .2s}
  .refresh-btn:hover{color:var(--text);border-color:var(--blue)}

  /* Role switcher */
  .role-switcher{display:flex;align-items:center;gap:8px;margin-bottom:16px;padding:10px 14px;background:var(--card);border:1px solid var(--border);border-radius:10px}
  .role-switcher label{font-size:.75rem;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.05em}
  .role-switcher select{background:var(--bg);color:var(--text);border:1px solid var(--border);border-radius:6px;padding:6px 10px;font-size:.85rem;cursor:pointer}
  .role-switcher select:focus{outline:none;border-color:var(--blue)}
  .role-tag{font-size:.7rem;padding:2px 8px;border-radius:12px;background:var(--pbg);color:var(--purple);font-weight:600}

  /* Approval items */
  .approval-item{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:16px;margin-bottom:12px}
  .approval-item .ai-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .approval-item .ai-title{font-size:.9rem;font-weight:600}
  .approval-item .ai-agent{font-size:.72rem;color:var(--muted)}
  .approval-item .ai-desc{font-size:.85rem;color:var(--muted);margin-bottom:12px;line-height:1.4}
  .approval-item .ai-actions{display:flex;gap:8px}
  .btn{padding:8px 16px;border-radius:8px;font-size:.8rem;font-weight:600;cursor:pointer;border:none;transition:all .2s}
  .btn-approve{background:var(--gbg);color:var(--green);border:1px solid rgba(34,197,94,.3)}
  .btn-approve:hover{background:rgba(34,197,94,.25)}
  .btn-reject{background:var(--rbg);color:var(--red);border:1px solid rgba(239,68,68,.3)}
  .btn-reject:hover{background:rgba(239,68,68,.25)}
  .btn-view{background:var(--bbg);color:var(--blue);border:1px solid rgba(59,130,246,.3)}
  .btn-view:hover{background:rgba(59,130,246,.25)}

  /* Empty state */
  .empty-state{text-align:center;padding:40px 20px;color:var(--muted)}
  .empty-state .emoji{font-size:2rem;margin-bottom:8px}
  .empty-state .msg{font-size:.9rem}
  .empty-state .detail{font-size:.75rem;margin-top:4px}

  /* VA task items */
  .task-item{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border);font-size:.85rem}
  .task-item:last-child{border-bottom:none}
  .task-priority{width:8px;height:8px;border-radius:50%;margin-right:10px;flex-shrink:0}
</style>
</head>
<body>

<!-- ROLE SWITCHER (admin only) -->
<div class="role-switcher" id="role-switcher" style="display:none">
  <label>Viewing as</label>
  <select id="role-select" onchange="switchRole(this.value)"></select>
  <span class="role-tag" id="role-tag"></span>
</div>

<!-- HEARTBEAT BANNER -->
<div class="hb hb-unknown" id="heartbeat">
  <div class="hb-status">
    <span class="hb-dot" id="hb-dot" style="background:var(--muted)"></span>
    <span id="hb-label">Connecting...</span>
  </div>
  <div class="hb-detail" id="hb-detail">Loading dashboard data</div>
</div>

<!-- HEADER -->
<div class="hdr">
  <div>
    <h1 id="dashboard-title">McFarlin Operations</h1>
    <div class="sub" id="date-line">Loading...</div>
  </div>
  <div class="stats" id="summary-stats">
    <div class="ms"><div class="v" style="color:var(--muted)">-</div><div class="l">Active</div></div>
    <div class="ms"><div class="v" style="color:var(--muted)">-</div><div class="l">Blocked</div></div>
    <div class="ms"><div class="v" style="color:var(--muted)">-</div><div class="l">Disabled</div></div>
    <div class="ms"><div class="v" style="color:var(--muted)">-</div><div class="l">Escalations</div></div>
  </div>
</div>

<!-- TABS -->
<div class="tabs" id="tabs-container">
  <div class="tab active" data-tab="overview" onclick="showTab('overview')">Overview</div>
  <div class="tab" data-tab="agents" onclick="showTab('agents')">Agents</div>
  <div class="tab" data-tab="approvals" onclick="showTab('approvals')">Approvals</div>
  <div class="tab" data-tab="tasks" onclick="showTab('tasks')">Tasks</div>
  <div class="tab" data-tab="system" onclick="showTab('system')">System</div>
</div>

<!-- OVERVIEW TAB -->
<div class="tab-content active" id="tab-overview">
  <div id="escalations-section" class="section" style="display:none">
    <div class="sec-t"><span style="color:var(--red)">&#9888;</span> Needs Your Attention</div>
    <div id="escalations-list"></div>
  </div>

  <div class="grid g2 section">
    <div class="card">
      <div class="card-t">Key Deadlines</div>
      <div id="deadlines-list">
        <div class="loading"><div class="loading-spin"></div><br>Loading...</div>
      </div>
    </div>
    <div class="card">
      <div class="card-t">Task Queue</div>
      <div id="tasks-summary">
        <div class="loading"><div class="loading-spin"></div><br>Loading...</div>
      </div>
    </div>
  </div>
</div>

<!-- AGENTS TAB -->
<div class="tab-content" id="tab-agents">
  <p style="font-size:.85rem;color:var(--muted);margin-bottom:16px">Agent status updated every 30 minutes by Operations Commander.</p>
  <div class="card" id="agents-list">
    <div class="loading"><div class="loading-spin"></div><br>Loading agents...</div>
  </div>
</div>

<!-- APPROVALS TAB -->
<div class="tab-content" id="tab-approvals">
  <div class="section">
    <div class="sec-t">Pending Approvals</div>
    <p style="font-size:.85rem;color:var(--muted);margin-bottom:16px">Items waiting for your review before agents can proceed.</p>
    <div id="approvals-list">
      <div class="loading"><div class="loading-spin"></div><br>Loading approvals...</div>
    </div>
  </div>
  <div class="section">
    <div class="sec-t" style="font-size:.95rem">Recent Decisions</div>
    <div id="approvals-history">
      <div style="font-size:.85rem;color:var(--muted);padding:12px 0">No recent decisions.</div>
    </div>
  </div>
</div>

<!-- TASKS TAB (for VAs) -->
<div class="tab-content" id="tab-tasks">
  <div class="section">
    <div class="sec-t">Your Tasks</div>
    <p style="font-size:.85rem;color:var(--muted);margin-bottom:16px">Tasks assigned to your role. Complete these and check back for updates.</p>
    <div class="card" id="va-tasks-list">
      <div class="loading"><div class="loading-spin"></div><br>Loading tasks...</div>
    </div>
  </div>
  <div class="section">
    <div class="sec-t" style="font-size:.95rem">Today's Schedule</div>
    <div class="card" id="va-schedule">
      <div style="font-size:.85rem;color:var(--muted)">No schedule data available yet.</div>
    </div>
  </div>
</div>

<!-- SYSTEM TAB -->
<div class="tab-content" id="tab-system">
  <div class="grid g2 section">
    <div class="card">
      <div class="card-t">Infrastructure Health</div>
      <div id="system-health">
        <div class="loading"><div class="loading-spin"></div><br>Loading...</div>
      </div>
    </div>
    <div class="card">
      <div class="card-t">Connection Info</div>
      <div id="connection-info" style="font-size:.85rem;color:var(--muted)">
        <div class="hi"><span>Data source</span><span>status.json via Cloudflare Pages</span></div>
        <div class="hi"><span>Refresh interval</span><span>Every 5 minutes</span></div>
        <div class="hi"><span>Mac Mini pushes</span><span>Every 15 minutes (auto-backup)</span></div>
        <div class="hi"><span>Status generated</span><span>Every 30 minutes (Ops Commander)</span></div>
      </div>
    </div>
  </div>
</div>

<div class="ts">
  <button class="refresh-btn" onclick="loadStatus()">Refresh Now</button>
  <div style="margin-top:8px" id="footer-ts">McFarlin AI Agent System &bull; Web Dashboard</div>
</div>

<script>
// ══════════════════════════════════════════
//  ROLE-BASED DASHBOARD CONFIGURATION
// ══════════════════════════════════════════

const ROLES_CONFIG = {
  roles: {
    admin: {
      label: 'Sean (Admin)',
      entities: 'all',
      agents: 'all',
      sections: ['overview', 'agents', 'system', 'approvals', 'tasks'],
      can_switch_roles: true,
      title: 'McFarlin Operations'
    },
    'rdre-marketing': {
      label: 'Amanda (RDRE)',
      entities: ['rdre'],
      agents: [3, 7, 12],
      sections: ['approvals', 'overview'],
      can_switch_roles: false,
      title: 'RDRE Marketing Dashboard'
    },
    'bvr-va': {
      label: 'VA (BVR)',
      entities: ['bvr'],
      agents: [2, 6],
      sections: ['tasks', 'overview'],
      can_switch_roles: false,
      title: 'BVR Operations Dashboard'
    }
  },
  users: {
    'sean@mcfarlin.com': 'admin',
    'amanda@mcfarlin.com': 'rdre-marketing'
  },
  agent_entities: {
    operations_commander: ['all'],
    bvr_operations: ['bvr'],
    seo_marketing: ['rdre', 'bvr', 'personal'],
    lead_crm: ['rdre'],
    financial_oversight: ['all'],
    bvr_property_listing: ['bvr'],
    website_content: ['rdre', 'bvr', 'personal'],
    contracts_legal: ['all'],
    process_improvement: ['all'],
    purchasing: ['bvr'],
    it_security: ['all'],
    social_media: ['rdre'],
    email_triage: ['all']
  }
};

const STATUS_URL = 'status.json';
let currentData = null;
let currentRole = 'admin'; // default, will be overridden by auth
let actualRole = 'admin';  // the user's real role (for admin switching back)

// ══════════════════════════════════════════
//  ROLE DETECTION & SWITCHING
// ══════════════════════════════════════════

function detectRole() {
  // Priority 1: URL parameter (for dev/testing and admin switching)
  const params = new URLSearchParams(window.location.search);
  const urlRole = params.get('role');
  if (urlRole && ROLES_CONFIG.roles[urlRole]) {
    currentRole = urlRole;
  }

  // Priority 2: Cloudflare Access JWT (production)
  // When Cloudflare Access is configured, it sets a cookie with the user's email.
  // We decode it to determine the role.
  const cfEmail = getCfAccessEmail();
  if (cfEmail) {
    const mappedRole = ROLES_CONFIG.users[cfEmail.toLowerCase()];
    if (mappedRole) {
      actualRole = mappedRole;
      // Only use CF role if no URL override, or if non-admin trying to override
      if (!urlRole) {
        currentRole = mappedRole;
      } else if (mappedRole !== 'admin' && urlRole !== mappedRole) {
        // Non-admin users can't switch roles via URL
        currentRole = mappedRole;
      }
    }
  }

  // Priority 3: localStorage (remembers admin's last viewed role)
  if (!urlRole && !cfEmail) {
    const saved = localStorage.getItem('dashboard-role');
    if (saved && ROLES_CONFIG.roles[saved]) {
      currentRole = saved;
    }
  }
}

function getCfAccessEmail() {
  // Cloudflare Access sets CF_Authorization cookie with a JWT
  // The JWT payload contains the user's email
  try {
    const cookies = document.cookie.split(';');
    for (const cookie of cookies) {
      const [name, value] = cookie.trim().split('=');
      if (name === 'CF_Authorization' && value) {
        const payload = JSON.parse(atob(value.split('.')[1]));
        return payload.email || null;
      }
    }
  } catch (e) {
    // No CF Access cookie or invalid JWT — that's fine
  }
  return null;
}

function switchRole(role) {
  if (!ROLES_CONFIG.roles[role]) return;
  currentRole = role;
  localStorage.setItem('dashboard-role', role);
  applyRole();
  if (currentData) renderAll(currentData);

  // Update URL without reload
  const url = new URL(window.location);
  if (role === actualRole) {
    url.searchParams.delete('role');
  } else {
    url.searchParams.set('role', role);
  }
  history.replaceState(null, '', url);
}

function applyRole() {
  const role = ROLES_CONFIG.roles[currentRole];
  if (!role) return;

  // Update title
  document.getElementById('dashboard-title').textContent = role.title;

  // Show/hide role switcher (admin only)
  const switcher = document.getElementById('role-switcher');
  if (actualRole === 'admin' || !getCfAccessEmail()) {
    // Show switcher for admin, or when no auth (dev mode)
    switcher.style.display = 'flex';
    const select = document.getElementById('role-select');
    if (select.options.length === 0) {
      for (const [key, r] of Object.entries(ROLES_CONFIG.roles)) {
        const opt = document.createElement('option');
        opt.value = key;
        opt.textContent = r.label;
        select.appendChild(opt);
      }
    }
    select.value = currentRole;
    document.getElementById('role-tag').textContent =
      currentRole === actualRole ? 'Your view' : 'Previewing';
  } else {
    switcher.style.display = 'none';
  }

  // Show/hide tabs based on role sections
  const allowedSections = role.sections;
  document.querySelectorAll('.tab').forEach(tab => {
    const tabId = tab.getAttribute('data-tab');
    tab.style.display = allowedSections.includes(tabId) ? '' : 'none';
  });

  // Make sure active tab is visible, otherwise switch to first allowed
  const activeTab = document.querySelector('.tab.active');
  const activeTabId = activeTab ? activeTab.getAttribute('data-tab') : null;
  if (!activeTabId || !allowedSections.includes(activeTabId)) {
    showTab(allowedSections[0]);
  }

  // Hide heartbeat for non-admin (they don't need to know about Mac Mini)
  const heartbeat = document.getElementById('heartbeat');
  if (currentRole === 'admin') {
    heartbeat.style.display = 'flex';
  } else {
    heartbeat.style.display = 'none';
  }

  // Adjust summary stats for non-admin
  // (they'll be recalculated when data renders)
}

// ══════════════════════════════════════════
//  TAB SWITCHING
// ══════════════════════════════════════════

function showTab(id) {
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  const content = document.getElementById('tab-' + id);
  const tab = document.querySelector('.tab[data-tab="' + id + '"]');
  if (content) content.classList.add('active');
  if (tab) tab.classList.add('active');
}

// ══════════════════════════════════════════
//  AGENT FILTERING
// ══════════════════════════════════════════

function filterAgentsForRole(agents) {
  const role = ROLES_CONFIG.roles[currentRole];
  if (!role || role.agents === 'all') return agents;

  const allowedNumbers = role.agents;
  const allowedEntities = role.entities;

  return agents.filter(a => {
    // Filter by agent number
    if (allowedNumbers.includes(a.number)) return true;

    // Also check entity match
    const agentEntities = ROLES_CONFIG.agent_entities[a.key] || [];
    if (agentEntities.includes('all')) return false; // cross-entity agents only for admin
    return agentEntities.some(e => allowedEntities.includes(e));
  });
}

function filterEscalationsForRole(escalations) {
  const role = ROLES_CONFIG.roles[currentRole];
  if (!role || role.entities === 'all') return escalations;

  const allowedEntities = role.entities;
  return escalations.filter(e => {
    const source = (e.source || '').toLowerCase();
    // Map escalation sources to entities
    if (allowedEntities.includes('rdre') && (source.includes('seo') || source.includes('social') || source.includes('website'))) return true;
    if (allowedEntities.includes('bvr') && (source.includes('bvr') || source.includes('hostaway'))) return true;
    return false;
  });
}

// ══════════════════════════════════════════
//  TIME HELPERS
// ══════════════════════════════════════════

function timeAgo(isoStr) {
  if (!isoStr) return 'Never';
  const diff = (Date.now() - new Date(isoStr).getTime()) / 1000;
  if (diff < 60) return 'Just now';
  if (diff < 3600) return Math.floor(diff / 60) + ' min ago';
  if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
  return Math.floor(diff / 86400) + 'd ago';
}

function formatDate(isoStr) {
  if (!isoStr) return '';
  const d = new Date(isoStr);
  return d.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
}

function formatTime(isoStr) {
  if (!isoStr) return '';
  const d = new Date(isoStr);
  return d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
}

// ══════════════════════════════════════════
//  HEARTBEAT
// ══════════════════════════════════════════

function updateHeartbeat(data) {
  const hb = document.getElementById('heartbeat');
  const dot = document.getElementById('hb-dot');
  const label = document.getElementById('hb-label');
  const detail = document.getElementById('hb-detail');

  if (!data || !data.heartbeat) {
    hb.className = 'hb hb-unknown';
    dot.style.background = 'var(--muted)';
    label.textContent = 'No Data';
    detail.textContent = 'Could not load status.json';
    return;
  }

  const ts = new Date(data.heartbeat.timestamp);
  const diffMin = (Date.now() - ts.getTime()) / 60000;

  if (diffMin < 60) {
    hb.className = 'hb hb-online';
    dot.style.background = 'var(--green)';
    label.textContent = 'Mac Mini Online';
    label.style.color = 'var(--green)';
    detail.textContent = 'Last heartbeat: ' + timeAgo(data.heartbeat.timestamp) + ' \u2022 ' + (data.heartbeat.hostname || '');
  } else if (diffMin < 120) {
    hb.className = 'hb hb-delayed';
    dot.style.background = 'var(--yellow)';
    label.textContent = 'Mac Mini \u2014 Delayed';
    label.style.color = 'var(--yellow)';
    detail.textContent = 'Last heartbeat: ' + Math.floor(diffMin) + ' min ago. May need attention soon.';
  } else {
    hb.className = 'hb hb-offline';
    dot.style.background = 'var(--red)';
    label.textContent = 'MAC MINI OFFLINE';
    label.style.color = 'var(--red)';
    const hours = Math.floor(diffMin / 60);
    detail.textContent = 'Last heartbeat: ' + hours + 'h ago. SSH in and log in to restart agents.';
  }
}

// ══════════════════════════════════════════
//  SUMMARY STATS
// ══════════════════════════════════════════

function updateSummary(data) {
  if (!data || !data.summary) return;

  const role = ROLES_CONFIG.roles[currentRole];

  if (currentRole === 'admin') {
    // Admin sees full stats
    const s = data.summary;
    document.getElementById('summary-stats').innerHTML = `
      <div class="ms"><div class="v" style="color:var(--green)">${s.active_agents}</div><div class="l">Active</div></div>
      <div class="ms"><div class="v" style="color:var(--yellow)">${s.blocked_agents}</div><div class="l">Blocked</div></div>
      <div class="ms"><div class="v" style="color:var(--muted)">${s.disabled_agents}</div><div class="l">Disabled</div></div>
      <div class="ms"><div class="v" style="color:var(--red)">${s.escalations}</div><div class="l">Escalations</div></div>
    `;
  } else if (currentRole === 'rdre-marketing') {
    // Amanda sees approval-focused stats
    const pending = (data.pending_approvals || []).length;
    const agents = filterAgentsForRole(data.agents || []);
    const activeAgents = agents.filter(a => a.status === 'running').length;
    document.getElementById('summary-stats').innerHTML = `
      <div class="ms"><div class="v" style="color:var(--yellow)">${pending}</div><div class="l">Pending</div></div>
      <div class="ms"><div class="v" style="color:var(--green)">${activeAgents}</div><div class="l">Agents</div></div>
      <div class="ms"><div class="v" style="color:var(--blue)">${agents.length}</div><div class="l">Your Agents</div></div>
    `;
  } else if (currentRole === 'bvr-va') {
    // VAs see task-focused stats
    const t = data.tasks || {};
    document.getElementById('summary-stats').innerHTML = `
      <div class="ms"><div class="v" style="color:var(--yellow)">${t.pending || 0}</div><div class="l">Open Tasks</div></div>
      <div class="ms"><div class="v" style="color:var(--green)">${t.completed || 0}</div><div class="l">Done</div></div>
      <div class="ms"><div class="v" style="color:var(--red)">${t.overdue || 0}</div><div class="l">Overdue</div></div>
    `;
  }

  document.getElementById('date-line').textContent = formatDate(data.generated_at) +
    ' \u2022 Updated ' + timeAgo(data.generated_at);
}

// ══════════════════════════════════════════
//  ESCALATIONS
// ══════════════════════════════════════════

function updateEscalations(data) {
  const section = document.getElementById('escalations-section');
  const list = document.getElementById('escalations-list');
  if (!data || !data.escalations) {
    section.style.display = 'none';
    return;
  }

  const filtered = currentRole === 'admin' ? data.escalations : filterEscalationsForRole(data.escalations);

  if (filtered.length === 0) {
    section.style.display = 'none';
    return;
  }
  section.style.display = 'block';
  list.innerHTML = filtered.map(e => `
    <div class="esc">
      <div class="esc-t">${escHtml(e.source || e.title || 'Alert')}</div>
      <div class="esc-d">Keyword: ${escHtml(e.keyword || e.detail || '')}</div>
    </div>
  `).join('');
}

// ══════════════════════════════════════════
//  DEADLINES
// ══════════════════════════════════════════

function updateDeadlines(data) {
  const el = document.getElementById('deadlines-list');
  if (!data || !data.deadlines || data.deadlines.length === 0) {
    el.innerHTML = '<div style="font-size:.85rem;color:var(--muted);padding:12px 0">No upcoming deadlines.</div>';
    return;
  }

  // For non-admin roles, show a simplified view
  const deadlines = currentRole === 'admin' ? data.deadlines : data.deadlines.slice(0, 3);

  el.innerHTML = deadlines.map(d => {
    const color = d.severity === 'high' ? 'var(--red)' : d.severity === 'medium' ? 'var(--yellow)' : 'var(--muted)';
    const days = d.days_until;
    const label = days < 0 ? Math.abs(days) + 'd overdue' : days === 0 ? 'TODAY' : days + 'd';
    return `<div class="dl">
      <span style="color:${color};font-weight:${d.severity==='high'?600:400}">${escHtml(d.text)}</span>
      <span class="badge ${d.severity==='high'?'br':d.severity==='medium'?'by':'bb'}" style="flex-shrink:0">${label}</span>
    </div>`;
  }).join('');
}

// ══════════════════════════════════════════
//  TASKS
// ══════════════════════════════════════════

function updateTasks(data) {
  const el = document.getElementById('tasks-summary');
  if (!data || !data.tasks) {
    el.innerHTML = '<div style="color:var(--muted)">No task data</div>';
    return;
  }
  const t = data.tasks;
  const total = t.pending + t.completed;
  const pct = total > 0 ? Math.round((t.completed / total) * 100) : 0;
  el.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:baseline;margin-bottom:8px">
      <div><span style="font-size:1.5rem;font-weight:700">${t.pending}</span> <span style="font-size:.8rem;color:var(--muted)">open</span></div>
      <div><span style="font-size:1.5rem;font-weight:700;color:var(--green)">${t.completed}</span> <span style="font-size:.8rem;color:var(--muted)">done</span></div>
    </div>
    <div class="pb"><div class="pf" style="width:${pct}%;background:var(--green)"></div></div>
    <div style="font-size:.75rem;color:var(--muted);margin-top:6px">${pct}% completion rate${t.overdue > 0 ? ' \u2022 <span style=\"color:var(--red)\">' + t.overdue + ' overdue</span>' : ''}</div>
  `;
}

// ══════════════════════════════════════════
//  AGENTS
// ══════════════════════════════════════════

function updateAgents(data) {
  const el = document.getElementById('agents-list');
  if (!data || !data.agents) {
    el.innerHTML = '<div style="color:var(--muted);padding:12px">No agent data</div>';
    return;
  }

  const agents = filterAgentsForRole(data.agents);

  if (agents.length === 0) {
    el.innerHTML = '<div style="color:var(--muted);padding:12px">No agents assigned to your role.</div>';
    return;
  }

  el.innerHTML = agents.map(a => {
    const statusMap = {
      running: { badge: 'bg', label: 'Running', dot: 'dg', numBg: 'var(--gbg)', numColor: 'var(--green)' },
      next_up: { badge: 'by', label: 'Next Up', dot: 'dy', numBg: 'var(--ybg)', numColor: 'var(--yellow)' },
      partial: { badge: 'bb', label: 'Partial', dot: 'db', numBg: 'var(--bbg)', numColor: 'var(--blue)' },
      wave2: { badge: 'by', label: 'Wave 2', dot: 'dy', numBg: 'var(--ybg)', numColor: 'var(--yellow)' },
      wave3: { badge: 'by', label: 'Wave 3', dot: 'dy', numBg: 'var(--ybg)', numColor: 'var(--yellow)' },
      wave4: { badge: 'bp', label: 'Wave 4', dot: 'dp', numBg: 'var(--border)', numColor: 'var(--muted)' },
      disabled: { badge: 'bp', label: 'Disabled', dot: 'dp', numBg: 'var(--border)', numColor: 'var(--muted)' },
    };
    const s = statusMap[a.status] || statusMap.disabled;
    const lastRun = a.last_log ? 'Last: ' + timeAgo(a.last_log) : 'No logs yet';

    return `<div class="ar">
      <div class="ar-main">
        <div class="ar-left">
          <div class="anum" style="background:${s.numBg};color:${s.numColor}">${a.number}</div>
          <div style="min-width:0">
            <div class="aname">${escHtml(a.name)}</div>
            <div class="adet">${escHtml(a.role)} \u2022 ${escHtml(a.schedule)} \u2022 ${lastRun}</div>
          </div>
        </div>
        <span class="badge ${s.badge}"><span class="dot ${s.dot}"></span> ${s.label}</span>
      </div>
    </div>`;
  }).join('');
}

// ══════════════════════════════════════════
//  APPROVALS (Amanda's primary interface)
// ══════════════════════════════════════════

function updateApprovals(data) {
  const el = document.getElementById('approvals-list');

  // Pending approvals come from status.json (generated by the Python script)
  const approvals = data.pending_approvals || [];

  if (approvals.length === 0) {
    el.innerHTML = `
      <div class="empty-state">
        <div class="emoji">&#10003;</div>
        <div class="msg">All caught up!</div>
        <div class="detail">No items waiting for your approval. Agents will notify you when something needs review.</div>
      </div>
    `;
    return;
  }

  el.innerHTML = approvals.map((item, i) => `
    <div class="approval-item">
      <div class="ai-header">
        <div class="ai-title">${escHtml(item.title || 'Pending Item')}</div>
        <span class="badge by">${escHtml(item.agent || 'Agent')}</span>
      </div>
      <div class="ai-desc">${escHtml(item.description || '')}</div>
      <div class="ai-actions">
        <button class="btn btn-approve" onclick="handleApproval(${i}, 'approve')">Approve</button>
        <button class="btn btn-reject" onclick="handleApproval(${i}, 'reject')">Reject</button>
        <button class="btn btn-view" onclick="handleApproval(${i}, 'view')">View Details</button>
      </div>
    </div>
  `).join('');
}

function handleApproval(index, action) {
  // For now, show a message. When the backend approval system is built,
  // this will write to logs/approvals/rdre-marketing/ via an API
  const actions = { approve: 'Approved', reject: 'Rejected', view: 'Viewing' };
  alert(actions[action] + ' — approval system backend coming soon. For now, text Sean or reply to the email.');
}

// ══════════════════════════════════════════
//  VA TASKS
// ══════════════════════════════════════════

function updateVaTasks(data) {
  const el = document.getElementById('va-tasks-list');

  // VA tasks will come from status.json once we add entity-filtered tasks
  const tasks = data.va_tasks || [];

  if (tasks.length === 0) {
    el.innerHTML = `
      <div class="empty-state">
        <div class="emoji">&#128203;</div>
        <div class="msg">No specific tasks assigned</div>
        <div class="detail">Check Hostaway for guest messages and follow the BVR SOP for daily operations.</div>
      </div>
    `;
    return;
  }

  el.innerHTML = tasks.map(t => {
    const priorityColor = t.priority === 'high' ? 'var(--red)' : t.priority === 'medium' ? 'var(--yellow)' : 'var(--green)';
    return `<div class="task-item">
      <div style="display:flex;align-items:center">
        <div class="task-priority" style="background:${priorityColor}"></div>
        <span>${escHtml(t.text || t.title || 'Task')}</span>
      </div>
      <span class="badge ${t.priority === 'high' ? 'br' : t.priority === 'medium' ? 'by' : 'bg'}">${escHtml(t.priority || 'normal')}</span>
    </div>`;
  }).join('');
}

// ══════════════════════════════════════════
//  SYSTEM HEALTH
// ══════════════════════════════════════════

function updateSystemHealth(data) {
  const el = document.getElementById('system-health');
  if (!data || !data.system_health) {
    el.innerHTML = '<div style="color:var(--muted)">No health data</div>';
    return;
  }

  const nameMap = {
    watchdog: 'Watchdog',
    auto_backup: 'Auto-Backup',
    morning_briefing: 'Morning Briefing',
    auto_merge: 'Auto-Merge',
    github_push: 'GitHub Push',
  };

  const h = data.system_health;
  el.innerHTML = Object.keys(h).map(key => {
    const item = h[key];
    const statusClass = item.status === 'ok' ? 'bg' : item.status === 'error' ? 'br' : 'by';
    const dotClass = item.status === 'ok' ? 'dg' : item.status === 'error' ? 'dr' : 'dy';
    const label = item.status === 'ok' ? 'OK' : item.status === 'error' ? 'Error' : 'Warning';
    return `<div class="hi">
      <span>${nameMap[key] || key}</span>
      <span class="badge ${statusClass}"><span class="dot ${dotClass}"></span> ${escHtml(item.detail || label)}</span>
    </div>`;
  }).join('');
}

// ══════════════════════════════════════════
//  HTML ESCAPING
// ══════════════════════════════════════════

function escHtml(str) {
  if (!str) return '';
  const d = document.createElement('div');
  d.textContent = str;
  return d.innerHTML;
}

// ══════════════════════════════════════════
//  RENDER ALL
// ══════════════════════════════════════════

function renderAll(data) {
  updateHeartbeat(data);
  updateSummary(data);
  updateEscalations(data);
  updateDeadlines(data);
  updateTasks(data);
  updateAgents(data);
  updateApprovals(data);
  updateVaTasks(data);
  updateSystemHealth(data);
}

// ══════════════════════════════════════════
//  LOAD STATUS
// ══════════════════════════════════════════

async function loadStatus() {
  try {
    const resp = await fetch(STATUS_URL + '?t=' + Date.now());
    if (!resp.ok) throw new Error('HTTP ' + resp.status);
    currentData = await resp.json();

    renderAll(currentData);

    document.getElementById('footer-ts').textContent =
      'McFarlin AI Agent System \u2022 Last loaded: ' + new Date().toLocaleTimeString();
  } catch (err) {
    console.error('Failed to load status:', err);
    updateHeartbeat(null);
    document.getElementById('date-line').textContent = 'Failed to load data \u2014 ' + err.message;
  }
}

// ══════════════════════════════════════════
//  INIT
// ══════════════════════════════════════════

detectRole();
applyRole();
loadStatus();
setInterval(loadStatus, 5 * 60 * 1000);
</script>

</body>
</html>
